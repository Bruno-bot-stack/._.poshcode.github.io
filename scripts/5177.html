
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Sign up for PowerShell.Slack.com">
    <meta name="author" content="dragonmc77">
    <title>Invoke-SQL - PoshCode</title>

    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <style>
        body {
            padding-top: 50px;
            padding-bottom: 20px;
        }
    </style>
</head>
<body>
    <header>
    <nav class="navbar navbar-expand-sm fixed-top navbar-dark bg-dark">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="http://PoshCode.org/">PoshCode</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
            <div id="navbarResponsive" class="collapse navbar-collapse navbar-responsive-collapse navbar-right">
                <ul class="nav navbar-nav nav-tabs ml-auto" data-tabs="tabs" id="tabs">
                    <li class="nav-item"><a class="nav-link active show" href="/scripts" data-toggle="tab">Scripts</a></li>
                    <li class="nav-item"><a class="nav-link" href="/video" data-toggle="tab">Video Feed</a></li>
                </ul>
            </div><!--/.navbar-collapse -->
        </div>
    </nav>
    </header>

    

<div class="blog-post">
    <h2 class="blog-post-title">Invoke-SQL</h2>
    <p class="blog-post-meta">
        <span class="blog-post-time">2014-05-21</span> by <a class="blog-post-author">dragonmc77</a>
    </p>

    <h1>Invoke-SQL</h1>
<h3><a href="//scripts/5177.ps1">download</a></h3>
<p>Execute a SQL command against a database using Powershell.</p>
<pre><code class="language-posh">function Invoke-Sql {
    &lt;#
    .SYNOPSIS
        Invokes a SQL command.
    .DESCRIPTION
        Executes a SQL command against the specified database.
    .PARAMETER Server
        The host name of the SQL server.
    .PARAMETER Database
        The name of the database against which the command will be executed.
    .PARAMETER Command
        The SQL command to execute, in Transact-SQL.
    .EXAMPLE
        None
    .OUTPUTS
        System.Data.SqlClient.SqlDataReader | System.Int64
    .NOTES
        This command returns output dependent upon the SQL command to execute. If it is a SELECT
        command, the result set is returned in the form of a SqlDataReader object. Otherwise, the
        command is executed and an integer representing the number of rows affected is returned.
    #&gt;

	param (	
		#the host name of the SQL server
		[string]$Server,
		#the name of the database
		[string]$Database,
		#the commands to execute (name of stored procedure)
		[string]$Command
	)

	$sqlConnection = New-Object System.Data.SqlClient.SqlConnection
	$sqlConnection.ConnectionString = &quot;Data Source=$Server;Initial Catalog=$Database;Integrated Security=True;MultipleActiveResultSets=True;&quot;
	$sqlCommand = New-Object System.Data.SqlClient.SqlCommand
	$sqlCommand.CommandType = [System.Data.CommandType]::Text
	$sqlCommand.CommandText = $Command
	
    try {
        $sqlConnection.Open()
	    $sqlCommand.Connection = $sqlConnection
        if ($Command -like &quot;SELECT*&quot;) {
        	&lt;#  if the command is a select statement, use ExecuteReader, which executes the query and returns
                the result set in an SQLDataReader object, which we return for consumption #&gt;
            return $sqlCommand.ExecuteReader([System.Data.CommandBehavior]::CloseConnection)
        } else {
            &lt;#  otherwise, use ExecuteNonQuery, which executes the command and returns the number of rows
                affected. #&gt;
            $sqlCommand.ExecuteNonQuery()
        }
	    $sqlConnection.Close()
    } catch {
        throw (&quot;Error executing command: {0}&quot; -f $_.Message)
    }
}
</code></pre>

</div>

    <footer class="blog-footer">
        <p>&copy; Joel &quot;Jaykul&quot; Bennett 2018</p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="/js/main.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-59988721-1', 'auto');
      ga('send', 'pageview');

      $(function () {
          $('#contentTabs a:first').tab('show')
      })

    </script>
</body>
</html>