<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Sign up for PowerShell.Slack.com">
    <meta name="author" content="TechJeeper">
    <title>Get-VMMemory - PoshCode</title>

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/main.css">
    <style>
        body {
            padding-top: 50px;
            padding-bottom: 20px;
        }
    </style>

    <link rel="openid2.provider" href="https://openid.stackexchange.com/openid/provider">
    <link rel="openid2.local_id" href="https://openid.stackexchange.com/user/b167be35-3674-4571-8142-df1f7dcfc268">
<!--
    <link rel="openid2.provider" href="https://www.google.com/accounts/o8/ud" />
    <link rel="openid2.local_id" href="https://profiles.google.com/+JoelBennett" />
-->
</head>
<body>
    <header>
    <nav class="navbar navbar-expand-sm fixed-top navbar-dark bg-dark">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="http://PoshCode.org/">PoshCode</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
            <div id="navbarResponsive" class="collapse navbar-collapse navbar-responsive-collapse navbar-right">
                <ul class="nav navbar-nav nav-tabs ml-auto" data-tabs="tabs" id="tabs">
                    <li class="nav-item"><a class="nav-link active show" href="/Scripts" data-toggle="tab">Scripts</a></li>
                    <li class="nav-item"><a class="nav-link" href="/video" data-toggle="tab">Video Feed</a></li>
                </ul>
            </div><!--/.navbar-collapse -->
        </div>
    </nav>
    </header>

    

<h1>Get-VMMemory</h1>
<h3><a href="//scripts/4326.ps1">download</a></h3>
<p>Function to retrieve memory usage percentage for a Windows VMWare virtual server remotely or locally.</p>
<p>Usage Get-VMMemory -ComputerName {ServerName} -Count {Int} -Delay {Int}</p>
<pre><code class="language-posh">Function Get-VMMemory {
&lt;# 
.SYNOPSIS
Retrieves memory usage percentage for a Windows VMWare virtual server. 
.DESCRIPTION
Often times the memory usage reported by Windows is incorrect on VMWare virtual servers.  This function utilizes the VMWare Performance counters to determin usage percentage.
.PARAMETER ComputerName
Specify a single computer, must be a Virtual server with VMWare Tools installed.
.PARAMETER Delay
The delay, in seconds, between tests
.PARAMETER Count
The number of times to report the memory usage
.EXAMPLE
Get-VMMemory -ComputerName Server1
Gets Memory usage for Server1 with the default 5 count and no delay
.EXAMPLE
Get-VMMemory -ComputerName Server1 -Count 4 -Delay 30
Gets Memory usage for Server1 4 times with a 30 second delay
.NOTES
NAME: Get-VMMemory
AUTHOR: Cody Dean
WEBSITE: http://www.TechJeeper.com
LASTEDIT: 07/19/2013
#&gt;  

    Param(
    [string]$ComputerName = $env:computername,
    [int]$Count = 5,
    [int]$Delay = 0
    )
$ErrorActionPreference = &quot;silentlycontinue&quot;
$server = $ComputerName
$vmMemActive = &quot;\VM Memory\Memory Active in MB&quot;
$vmMemUsed = &quot;\VM Memory\Memory Used in MB&quot;

$used = Get-Counter -ComputerName $server -Counter $vmMemUsed|Foreach-Object {$_.CounterSamples[0].CookedValue}

if ($used)
{
    if ($Delay -gt 2)
    {
        $Delay = $Delay - 2
    }

$totalMem = $used / 1024
$totalMem = &quot;{0:N2}&quot; -f $totalMem
Write-Host &quot;$server - Total Memory (GB): $totalMem&quot;
$x = 0

while ($x -lt $Count)
{
    $x++
    $time = Get-Date -f T
    $active = Get-Counter -ComputerName $server -Counter $vmMemActive|Foreach-Object {$_.CounterSamples[0].CookedValue}
    $used = Get-Counter -ComputerName $server -Counter $vmMemUsed|Foreach-Object {$_.CounterSamples[0].CookedValue}
    $percentage = $active / $used
    $percentage = $percentage * 100
    $percentage = &quot;{0:N0}&quot; -f $percentage

    if ($percentage -ge 80)
    {
        Write-Host &quot;$time - Memory Usage: $percentage%&quot; -ForegroundColor Red
    }
    else
    {
        Write-Host &quot;$time - Memory Usage: $percentage%&quot;
    }
   
}

}
else
{
    Write-Host &quot;ERROR: VMWARE PERFORMANCE COUNTERS NOT FOUND OR HOST COULD NOT BE REACHED&quot; -ForegroundColor Red -BackgroundColor Black
}}
</code></pre>

    <footer class="blog-footer">
        <p>Â© Joel "Jaykul" Bennett 2018.</p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="js/main.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-59988721-1', 'auto');
      ga('send', 'pageview');

      $(function () {
          $('#contentTabs a:first').tab('show')
      })

    </script>
</body>
</html>