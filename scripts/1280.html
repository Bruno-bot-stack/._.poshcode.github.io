
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="PoshCode - Community resources for PowerShell coders">
    <meta name="author" content="psukus">
    <title>Audit iPhone Users - PoshCode</title>

    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <style>
        body {
            padding-top: 50px;
            padding-bottom: 20px;
        }
    </style>
</head>
<body>
    <header>
    <nav class="navbar navbar-expand-sm fixed-top navbar-dark bg-dark">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="http://PoshCode.org/">PoshCode</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
            <div id="navbarResponsive" class="collapse navbar-collapse navbar-responsive-collapse navbar-right">
                <ul class="nav navbar-nav nav-tabs ml-auto" data-tabs="tabs" id="tabs">
                    <li class="nav-item"><a class="nav-link active show" href="/scripts" data-toggle="tab">Scripts</a></li>
                    <li class="nav-item"><a class="nav-link" href="/video" data-toggle="tab">Video Feed</a></li>
                </ul>
            </div><!--/.navbar-collapse -->
        </div>
    </nav>
    </header>

    

<div class="blog-post">
    <h2 class="blog-post-title">Audit iPhone Users</h2>
    <p class="blog-post-meta">
        <span class="blog-post-time">2009-08-17</span> by <a class="blog-post-author">psukus</a>
    </p>

    <h1>Audit iPhone Users</h1>
<h3><a href="//scripts/1280.ps1">download</a></h3>
<p>This script is intended to use IIS logs to audit OWA logs for syncing of mail from an iPhone. In our environment this is an unauthorized device and needs to be audited. This script is not perfect, nor the prettiest thing in the world but it works. IIS logging must be on for this to work. email the results to yourself in $To varible. Have Fun!</p>
<pre><code class="language-posh">#Created by P. Sukus
#Name: iPhone users syncing through OWA audit 
#set the timeframe to audit in days
$Daysold = 1 
$Date = (get-date).adddays(-$daysold)
$servers = &quot;server1&quot;, &quot;server2&quot;, &quot;server3&quot;
foreach ($s in $servers) 
    {
    Write-host -ForegroundColor Blue &quot;Checking server $s for files from the last $daysold day(s)&quot;
    $logfiles += gci -path \\$s\c$\windows\system32\logfiles\W3SVC1 | where {$_.LastWriteTime -gt $date}
    }
Foreach ($l in $logfiles)
    {
    Write-host &quot;Processing &quot;$l.fullname
    Copy-item $l.fullname -Destination $pwd.path
    $listousers += gc $l.name | where {$_ -match &quot;DeviceType=&quot;}
    Remove-Item $l.name
    }
$user = @()
foreach ($l in $listousers | where {$_ -ne $null})
    {
    $u = $l.split(&quot; &quot;)[8]
    if ($user -notcontains $u)
        {
        $user += &quot;$u&quot;
        }
    $u = $null
    }
$body = &quot;&lt;!DOCTYPE html PUBLIC `&quot;-//W3C//DTD XHTML 1.0 Strict//EN`&quot;  `&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd`&quot;&gt;&quot;
$body += &quot;&lt;html xmlns=`&quot;http://www.w3.org/1999/xhtml`&quot;&gt;&quot;
$body += &quot;&lt;head&gt;&quot;
$body += &quot;&lt;title&gt;iPhone Users&lt;/title&gt;&quot;
$body += &quot;&lt;/head&gt;&lt;body&gt;&quot;
$body += &quot;&lt;table border=1&gt;&quot;
$body += &quot;&lt;colgroup&gt;&quot;
$body += &quot;&lt;col/&gt;&quot;
$body += &quot;&lt;/colgroup&gt;&quot;
$body += &quot;&lt;tr&gt;&lt;td&gt;&lt;b&gt;iPhone Users&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&quot;
foreach ($y in $user)
    {
    $body += &quot;&lt;tr&gt;&lt;td&gt;$y&lt;/td&gt;&lt;/tr&gt;&quot;
    }
$body += &quot;&lt;/table&gt;&quot;
$body += &quot;&lt;/body&gt;&lt;/html&gt;&quot;

$smtpServer = &quot;your.SMTPserver.here&quot;
$mailer = new-object Net.Mail.SMTPclient($smtpserver)	
$From = &quot;iphoneusersync@company.internal&quot;
$To = &quot;admin@company.internal&quot;
$subject = &quot;iPhone users syncing through OWA in the last $daysold day(s)&quot;
$msg = new-object Net.Mail.MailMessage($from,$to,$subject,$body)	
$msg.IsBodyHTML = $true
$mailer.send($msg)

</code></pre>

</div>

    <footer class="blog-footer">
        <p>&copy; Joel &quot;Jaykul&quot; Bennett 2018</p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="/js/main.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-59988721-1', 'auto');
      ga('send', 'pageview');

      $(function () {
          $('#contentTabs a:first').tab('show')
      })

    </script>
</body>
</html>