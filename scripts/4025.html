
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="PoshCode - Community resources for PowerShell coders">
    <meta name="author" content="TechJeeper">
    <title>RunAsAdmin Tool - PoshCode</title>

    <link rel="stylesheet" href="/css/superhero.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/highlight/arta.css">
    <style>
        body {
            padding-top: 50px;
            padding-bottom: 20px;
        }
    </style>
</head>
<body>
    <header>
    <nav class="navbar navbar-expand-sm fixed-top navbar-dark bg-dark">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="http://PoshCode.org/">PoshCode</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
            <div id="navbarResponsive" class="collapse navbar-collapse navbar-responsive-collapse navbar-right">
                <ul class="nav navbar-nav nav-tabs ml-auto" id="tabs">
                    <li class="nav-item"><a class="nav-link" href="/">Join Us!</a></li>
                    <li class="nav-item"><a class="nav-link active show" href="/scripts" data-toggle="tab">Scripts</a></li>
                    <li class="nav-item"><a class="nav-link" href="/video">Videos</a></li>
                </ul>
            </div><!--/.navbar-collapse -->
        </div>
    </nav>
    </header>

	<div class="container">
		<div class="blog-header">
			<h1 class="blog-title">PoshCode</h1>
			<p class="lead blog-description">Community resources for PowerShell coders</p>
		</div>
		<div class="row">
            

<div class="blog-post">
    <h2 class="blog-post-title">RunAsAdmin Tool</h2>
    <p class="blog-post-meta">
        <span class="blog-post-time">2013-03-17</span> by <a class="blog-post-author">TechJeeper</a>
    </p>

    <h3>Download <a href="/scripts/4025.ps1">RunAsAdmin Tool.ps1</a></h3>
<p>RunAsAdmin is an application to help adhere to the best practice of least privileges.  It creates an .exe that the user can double click and it will execute a program with elevated privileges.  Users must be in a local group in order to execute the process.  For complete details visit: http://techjeeper.com/?page_id=112</p>
<pre><code class="language-powershell">&lt;# 

DOWNLOAD THE DEPLOY PACKAGE FROM http://techjeeper.com/?page_id=112 for all the pieces to make this work. 

Author: Cody Dean (aka TechJeeper)
Date: 3-16-2013

RunAsAdmin uses (and includes) the following tools:
PowerShell Community Extensions
SysInternals PsExec
PSTerminalServices
Make-ps1exewrapper.ps1
PowerShellPack

To implement a new RunAsAdmin program, extract the RunAsAdmin.zip to the C:\Tools\ directory.

From an Administrator PowerShell prompt do the following:

PS&gt; cd C:\Tools\
PS C:\Tools\&gt; .\Deploy-RunAsAdmin.ps1

The Deploy RunAsAdmin window will appear.

GUI Description: 
Application Path: The path to the application you want to run with elevated privileges.
Task Name: The name given to the application (will be the name of the exe the user will run)
Project Short-Name:  A “name” for the project, allows for multiple programs to utilize a single group for user access.
Service Account Name:  The name of the Service Account that will be an Administrator and will run the program.  If the SA doesn’t exist, it will be created.
Service Account Password:  The password for the SA.  If the SA exists, password must match existing password.
Cleanup Checkbox: If checked, the source files will be deleted, leaving only the files for the process in C:\Tools.
#&gt;

#Checks Powershell Version
$winVersion = (Get-WmiObject Win32_OperatingSystem).Caption
$psVersion = $Host.Version
$psVersion = $psVersion.Major


 If ($psVersion -eq &quot;3&quot;)
    {
    
        Function Get-Script
        {
            If ($myInvocation.ScriptName) { $myInvocation.ScriptName }
            else { $myInvocation.MyCommand.Definition }
        }
        
        $script = Get-Script
    
        Write-Host &quot;PowerShell Version 3 Detected... Starting Powershell Version 2 Window&quot;
        $powershell = &quot;powershell.exe -version 2 -file $script&quot;
        invoke-expression $powershell
        exit
    }

&lt;#
Make-PS1ExeWrapper.ps1 Fuction
Author: Keith Hill
Date:   Aug 7, 2010
http://rkeithhill.wordpress.com
#&gt;
function make-exe
{


[CmdletBinding(DefaultParameterSetName=&quot;Path&quot;)]
param(
    [Parameter(Mandatory=$true, Position=0, ParameterSetName=&quot;Path&quot;,
               ValueFromPipeline=$true, ValueFromPipelineByPropertyName=$true,
               HelpMessage=&quot;Path to bitmap file&quot;)]
    [ValidateNotNullOrEmpty()]
    [string[]]
    $Path,
    
    [Alias(&quot;PSPath&quot;)]
    [Parameter(Mandatory=$true, Position=0, ParameterSetName=&quot;LiteralPath&quot;, 
               ValueFromPipelineByPropertyName=$true,
               HelpMessage=&quot;Path to bitmap file&quot;)]
    [ValidateNotNullOrEmpty()]
    [string[]]
    $LiteralPath,

    [Parameter(Mandatory = $true, Position = 1)]
    [string]
    $OutputAssembly,
    
    [Parameter(Position = 2)]
    [string]
    $IconPath,
    
    [Parameter()]
    [switch]
    $STA
)

Begin {
    Set-StrictMode -Version latest 
    
    $MainAttribute = ''
    $ApartmentState = 'System.Threading.ApartmentState.MTA'
    if ($Sta)
    {
        $MainAttribute = '[STAThread]'
        $ApartmentState = 'System.Threading.ApartmentState.STA'
    }
    
    $src = @'
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Globalization;
using System.IO;
using System.IO.Compression;
using System.Management.Automation;
using System.Management.Automation.Host;
using System.Management.Automation.Runspaces;
using System.Reflection;
using System.Security;
using System.Text;
using System.Threading;

namespace PS1ToExeTemplate
{
    class Program
    {
        private static object _powerShellLock = new object();
        private static readonly Host _host = new Host();
        private static PowerShell _powerShellEngine;

'@ + @&quot;
$MainAttribute

&quot;@ + @'
        static void Main(string[] args)
        {
            Console.CancelKeyPress += Console_CancelKeyPress;
            Console.TreatControlCAsInput = false;

            string script = GetScript();
            RunScript(script, args, null);
        }

        private static string GetScript()
        {
            string script = String.Empty;

            Assembly assembly = Assembly.GetExecutingAssembly();
            using (Stream stream = assembly.GetManifestResourceStream(&quot;Resources.Script.ps1.gz&quot;))
            {
                var gZipStream = new GZipStream(stream, CompressionMode.Decompress, true);
                var streamReader = new StreamReader(gZipStream);
                script = streamReader.ReadToEnd();
            }

            return script;
        }

        private static void RunScript(string script, string[] args, object input)
        {
            lock (_powerShellLock)
            {
                _powerShellEngine = PowerShell.Create();
            }

            try
            {
                _powerShellEngine.Runspace = RunspaceFactory.CreateRunspace(_host);
                _powerShellEngine.Runspace.ApartmentState = 
'@ + @&quot;                
                $ApartmentState;
                
&quot;@ + @'                
                _powerShellEngine.Runspace.Open();
                _powerShellEngine.AddScript(script);
                _powerShellEngine.AddCommand(&quot;Out-Default&quot;);
                _powerShellEngine.Commands.Commands[0].MergeMyResults(PipelineResultTypes.Error, PipelineResultTypes.Output);

                if (input != null)
                {
                    _powerShellEngine.Invoke(new[] { input });
                }
                else
                {
                    _powerShellEngine.Invoke();
                }
            }
            finally
            {
                lock (_powerShellLock)
                {
                    _powerShellEngine.Dispose();
                    _powerShellEngine = null;
                }
            }
        }

        private static void Console_CancelKeyPress(object sender, ConsoleCancelEventArgs e)
        {
            try
            {
                lock (_powerShellLock)
                {
                    if (_powerShellEngine != null &amp;&amp; _powerShellEngine.InvocationStateInfo.State == PSInvocationState.Running)
                    {
                        _powerShellEngine.Stop();
                    }
                }
                e.Cancel = true;
            }
            catch (Exception ex)
            {
                _host.UI.WriteErrorLine(ex.ToString());
            }
        }
    }

    class Host : PSHost
    {
        private PSHostUserInterface _psHostUserInterface = new HostUserInterface();

        public override void SetShouldExit(int exitCode)
        {
            Environment.Exit(exitCode);
        }

        public override void EnterNestedPrompt()
        {
            throw new NotImplementedException();
        }

        public override void ExitNestedPrompt()
        {
            throw new NotImplementedException();
        }

        public override void NotifyBeginApplication()
        {
        }

        public override void NotifyEndApplication()
        {
        }

        public override string Name
        {
            get { return &quot;PSCX-PS1ToExeHost&quot;; }
        }

        public override Version Version
        {
            get { return new Version(1, 0); }
        }

        public override Guid InstanceId
        {
            get { return new Guid(&quot;E4673B42-84B6-4C43-9589-95FAB8E00EB2&quot;); }
        }

        public override PSHostUserInterface UI
        {
            get { return _psHostUserInterface; }
        }

        public override CultureInfo CurrentCulture
        {
            get { return Thread.CurrentThread.CurrentCulture; }
        }

        public override CultureInfo CurrentUICulture
        {
            get { return Thread.CurrentThread.CurrentUICulture; }
        }
    }

    class HostUserInterface : PSHostUserInterface, IHostUISupportsMultipleChoiceSelection
    {
        private PSHostRawUserInterface _psRawUserInterface = new HostRawUserInterface();

        public override PSHostRawUserInterface RawUI
        {
            get { return _psRawUserInterface; }
        }

        public override string ReadLine()
        {
            return Console.ReadLine();
        }

        public override SecureString ReadLineAsSecureString()
        {
            throw new NotImplementedException();
        }

        public override void Write(string value)
        {
            string output = value ?? &quot;null&quot;;
            Console.Write(output);
        }

        public override void Write(ConsoleColor foregroundColor, ConsoleColor backgroundColor, string value)
        {
            string output = value ?? &quot;null&quot;;
            var origFgColor = Console.ForegroundColor;
            var origBgColor = Console.BackgroundColor;
            Console.ForegroundColor = foregroundColor;
            Console.BackgroundColor = backgroundColor;
            Console.Write(output);
            Console.ForegroundColor = origFgColor;
            Console.BackgroundColor = origBgColor;
        }

        public override void WriteLine(string value)
        {
            string output = value ?? &quot;null&quot;;
            Console.WriteLine(output);
        }

        public override void WriteErrorLine(string value)
        {
            string output = value ?? &quot;null&quot;;
            var origFgColor = Console.ForegroundColor;
            Console.ForegroundColor = ConsoleColor.Red;
            Console.WriteLine(output);
            Console.ForegroundColor = origFgColor;
        }

        public override void WriteDebugLine(string message)
        {
            WriteYellowAnnotatedLine(message, &quot;DEBUG&quot;);
        }

        public override void WriteVerboseLine(string message)
        {
            WriteYellowAnnotatedLine(message, &quot;VERBOSE&quot;);
        }

        public override void WriteWarningLine(string message)
        {
            WriteYellowAnnotatedLine(message, &quot;WARNING&quot;);
        }

        private void WriteYellowAnnotatedLine(string message, string annotation)
        {
            string output = message ?? &quot;null&quot;;
            var origFgColor = Console.ForegroundColor;
            var origBgColor = Console.BackgroundColor;
            Console.ForegroundColor = ConsoleColor.Yellow;
            Console.BackgroundColor = ConsoleColor.Black;
            WriteLine(String.Format(CultureInfo.CurrentCulture, &quot;{0}: {1}&quot;, annotation, output));
            Console.ForegroundColor = origFgColor;
            Console.BackgroundColor = origBgColor;
        }

        public override void WriteProgress(long sourceId, ProgressRecord record)
        {
            throw new NotImplementedException();
        }

        public override Dictionary&lt;string, PSObject&gt; Prompt(string caption, string message, Collection&lt;FieldDescription&gt; descriptions)
        {
            if (String.IsNullOrEmpty(caption) &amp;&amp; String.IsNullOrEmpty(message) &amp;&amp; descriptions.Count &gt; 0)
            {
                Console.Write(descriptions[0].Name + &quot;: &quot;);
            }
            else
            {
                this.Write(ConsoleColor.DarkCyan, ConsoleColor.Black, caption + &quot;\n&quot; + message + &quot; &quot;);                
            }
            var results = new Dictionary&lt;string, PSObject&gt;();
            foreach (FieldDescription fd in descriptions)
            {
                string[] label = GetHotkeyAndLabel(fd.Label);
                this.WriteLine(label[1]);
                string userData = Console.ReadLine();
                if (userData == null)
                {
                    return null;
                }

                results[fd.Name] = PSObject.AsPSObject(userData);
            }

            return results;
        }

        public override PSCredential PromptForCredential(string caption, string message, string userName, string targetName)
        {
            throw new NotImplementedException();
        }

        public override PSCredential PromptForCredential(string caption, string message, string userName, string targetName, PSCredentialTypes allowedCredentialTypes, PSCredentialUIOptions options)
        {
            throw new NotImplementedException();
        }

        public override int PromptForChoice(string caption, string message, Collection&lt;ChoiceDescription&gt; choices, int defaultChoice)
        {
            // Write the caption and message strings in Blue.
            this.WriteLine(ConsoleColor.Blue, ConsoleColor.Black, caption + &quot;\n&quot; + message + &quot;\n&quot;);

            // Convert the choice collection into something that is
            // easier to work with. See the BuildHotkeysAndPlainLabels 
            // method for details.
            string[,] promptData = BuildHotkeysAndPlainLabels(choices);

            // Format the overall choice prompt string to display.
            var sb = new StringBuilder();
            for (int element = 0; element &lt; choices.Count; element++)
            {
                sb.Append(String.Format(CultureInfo.CurrentCulture, &quot;|{0}&gt; {1} &quot;, promptData[0, element], promptData[1, element]));
            }

            sb.Append(String.Format(CultureInfo.CurrentCulture, &quot;[Default is ({0}]&quot;, promptData[0, defaultChoice]));

            // Read prompts until a match is made, the default is
            // chosen, or the loop is interrupted with ctrl-C.
            while (true)
            {
                this.WriteLine(sb.ToString());
                string data = Console.ReadLine().Trim().ToUpper(CultureInfo.CurrentCulture);

                // If the choice string was empty, use the default selection.
                if (data.Length == 0)
                {
                    return defaultChoice;
                }

                // See if the selection matched and return the
                // corresponding index if it did.
                for (int i = 0; i &lt; choices.Count; i++)
                {
                    if (promptData[0, i] == data)
                    {
                        return i;
                    }
                }

                this.WriteErrorLine(&quot;Invalid choice: &quot; + data);
            }
        }

        #region IHostUISupportsMultipleChoiceSelection Members

        public Collection&lt;int&gt; PromptForChoice(string caption, string message, Collection&lt;ChoiceDescription&gt; choices, IEnumerable&lt;int&gt; defaultChoices)
        {
            this.WriteLine(ConsoleColor.Blue, ConsoleColor.Black, caption + &quot;\n&quot; + message + &quot;\n&quot;);

            string[,] promptData = BuildHotkeysAndPlainLabels(choices);

            var sb = new StringBuilder();
            for (int element = 0; element &lt; choices.Count; element++)
            {
                sb.Append(String.Format(CultureInfo.CurrentCulture, &quot;|{0}&gt; {1} &quot;, promptData[0, element], promptData[1, element]));
            }

            var defaultResults = new Collection&lt;int&gt;();
            if (defaultChoices != null)
            {
                int countDefaults = 0;
                foreach (int defaultChoice in defaultChoices)
                {
                    ++countDefaults;
                    defaultResults.Add(defaultChoice);
                }

                if (countDefaults != 0)
                {
                    sb.Append(countDefaults == 1 ? &quot;[Default choice is &quot; : &quot;[Default choices are &quot;);
                    foreach (int defaultChoice in defaultChoices)
                    {
                        sb.AppendFormat(CultureInfo.CurrentCulture, &quot;\&quot;{0}\&quot;,&quot;, promptData[0, defaultChoice]);
                    }
                    sb.Remove(sb.Length - 1, 1);
                    sb.Append(&quot;]&quot;);
                }
            }

            this.WriteLine(ConsoleColor.Cyan, ConsoleColor.Black, sb.ToString());

            var results = new Collection&lt;int&gt;();
            while (true)
            {
            ReadNext:
                string prompt = string.Format(CultureInfo.CurrentCulture, &quot;Choice[{0}]:&quot;, results.Count);
                this.Write(ConsoleColor.Cyan, ConsoleColor.Black, prompt);
                string data = Console.ReadLine().Trim().ToUpper(CultureInfo.CurrentCulture);

                if (data.Length == 0)
                {
                    return (results.Count == 0) ? defaultResults : results;
                }

                for (int i = 0; i &lt; choices.Count; i++)
                {
                    if (promptData[0, i] == data)
                    {
                        results.Add(i);
                        goto ReadNext;
                    }
                }

                this.WriteErrorLine(&quot;Invalid choice: &quot; + data);
            }
        }

        #endregion

        private static string[,] BuildHotkeysAndPlainLabels(Collection&lt;ChoiceDescription&gt; choices)
        {
            // Allocate the result array
            string[,] hotkeysAndPlainLabels = new string[2, choices.Count];

            for (int i = 0; i &lt; choices.Count; ++i)
            {
                string[] hotkeyAndLabel = GetHotkeyAndLabel(choices[i].Label);
                hotkeysAndPlainLabels[0, i] = hotkeyAndLabel[0];
                hotkeysAndPlainLabels[1, i] = hotkeyAndLabel[1];
            }

            return hotkeysAndPlainLabels;
        }

        private static string[] GetHotkeyAndLabel(string input)
        {
            string[] result = new string[] { String.Empty, String.Empty };
            string[] fragments = input.Split('&amp;');
            if (fragments.Length == 2)
            {
                if (fragments[1].Length &gt; 0)
                {
                    result[0] = fragments[1][0].ToString().
                    ToUpper(CultureInfo.CurrentCulture);
                }

                result[1] = (fragments[0] + fragments[1]).Trim();
            }
            else
            {
                result[1] = input;
            }

            return result;
        }
    }

    class HostRawUserInterface : PSHostRawUserInterface
    {
        public override KeyInfo ReadKey(ReadKeyOptions options)
        {
            throw new NotImplementedException();
        }

        public override void FlushInputBuffer()
        {
        }

        public override void SetBufferContents(Coordinates origin, BufferCell[,] contents)
        {
            throw new NotImplementedException();
        }

        public override void SetBufferContents(Rectangle rectangle, BufferCell fill)
        {
            throw new NotImplementedException();
        }

        public override BufferCell[,] GetBufferContents(Rectangle rectangle)
        {
            throw new NotImplementedException();
        }

        public override void ScrollBufferContents(Rectangle source, Coordinates destination, Rectangle clip, BufferCell fill)
        {
            throw new NotImplementedException();
        }

        public override ConsoleColor ForegroundColor
        {
            get { return Console.ForegroundColor; }
            set { Console.ForegroundColor = value; }
        }

        public override ConsoleColor BackgroundColor
        {
            get { return Console.BackgroundColor; }
            set { Console.BackgroundColor = value; }
        }

        public override Coordinates CursorPosition
        {
            get { return new Coordinates(Console.CursorLeft, Console.CursorTop); }
            set { Console.SetCursorPosition(value.X, value.Y); }
        }

        public override Coordinates WindowPosition
        {
            get { return new Coordinates(Console.WindowLeft, Console.WindowTop); }
            set { Console.SetWindowPosition(value.X, value.Y); }
        }

        public override int CursorSize
        {
            get { return Console.CursorSize; }
            set { Console.CursorSize = value; }
        }

        public override Size BufferSize
        {
            get { return new Size(Console.BufferWidth, Console.BufferHeight); }
            set { Console.SetBufferSize(value.Width, value.Height); }
        }

        public override Size WindowSize
        {
            get { return new Size(Console.WindowWidth, Console.WindowHeight); }
            set { Console.SetWindowSize(value.Width, value.Height); }
        }

        public override Size MaxWindowSize
        {
            get { return new Size(Console.LargestWindowWidth, Console.LargestWindowHeight); }
        }

        public override Size MaxPhysicalWindowSize
        {
            get { return new Size(Console.LargestWindowWidth, Console.LargestWindowHeight); }
        }

        public override bool KeyAvailable
        {
            get { return Console.KeyAvailable; }
        }

        public override string WindowTitle
        {
            get { return Console.Title; }
            set { Console.Title = value; }
        }
    }
}
'@
}    

Process {
    if ($psCmdlet.ParameterSetName -eq &quot;Path&quot;)
    {
        # In the -Path (non-literal) case we may need to resolve a wildcarded path
        $resolvedPaths = @($Path | Resolve-Path | Convert-Path)
    }
    else 
    {
        # Must be -LiteralPath
        $resolvedPaths = @($LiteralPath | Convert-Path)
    }
 
    foreach ($rpath in $resolvedPaths) 
    {
        Write-Verbose &quot;Processing $rpath&quot;

        $gzItem = Get-ChildItem $rpath | Write-GZip -Quiet 
        $resourcePath = &quot;$($gzItem.Directory)\Resources.Script.ps1.gz&quot;
        if (Test-Path $resourcePath) { Remove-Item $resourcePath }
        Rename-Item $gzItem $resourcePath
        
        # Configure the compiler parameters
        $referenceAssemblies = 'System.dll',([psobject].Assembly.Location)
        $outputPath = $OutputAssembly
        if (![IO.Path]::IsPathRooted($outputPath))
        {
            $outputPath = [io.path]::GetFullPath((Join-Path $pwd $outputPath))
        }
        if ($rpath -eq $outputPath)
        { 
            throw 'Oops, you don''t really want to overwrite your script with an EXE.' 
        }

        $cp = new-object System.CodeDom.Compiler.CompilerParameters $referenceAssemblies,$outputPath,$true
        $cp.TempFiles = new-object System.CodeDom.Compiler.TempFileCollection ([IO.Path]::GetTempPath())
        $cp.GenerateExecutable = $true
        $cp.GenerateInMemory   = $false
        $cp.IncludeDebugInformation = $true
        if ($IconPath) 
        {
            $rIconPath = Resolve-Path $IconPath
            $cp.CompilerOptions = &quot; /win32icon:$rIconPath&quot;
        }
        [void]$cp.EmbeddedResources.Add($resourcePath)
        
        # Create the C# codedom compiler
        $dict = new-object 'System.Collections.Generic.Dictionary[string,string]' 
        $dict.Add('CompilerVersion','v3.5')
        $provider = new-object Microsoft.CSharp.CSharpCodeProvider $dict
        
        # Compile the source and report errors
        $results = $provider.CompileAssemblyFromSource($cp, $src)
        if ($results.Errors.Count)
        {
            $errorLines = &quot;&quot; 
            foreach ($error in $results.Errors) 
            { 
                $errorLines += &quot;`n`t&quot; + $error.Line + &quot;:`t&quot; + $error.ErrorText 
            }
            Write-Error $errorLines
        }
    }  
}}


    function Reload-Profile {
    @(
        $Profile.AllUsersAllHosts,
        $Profile.AllUsersCurrentHost,
        $Profile.CurrentUserAllHosts,
        $Profile.CurrentUserCurrentHost
    ) | % {
        if(Test-Path $_){
            Write-Verbose &quot;Running $_&quot;
            . $_
        }
    }    
}


$pspCheck = $NULL
$pspCheck = Get-Module -ListAvailable | Where-Object {$_.Name -eq &quot;PowerShellPack&quot;}
if (!$pspCheck)
{
    Write-Host &quot;Installing PowerShellPack... Please Wait...&quot;
    $install = &quot;C:\Tools\PowerShellPack.msi /quiet&quot;
    invoke-expression $install
    Start-Sleep -Seconds 30
    Reload-Profile
        
}
$pscxCheck = $NULL
$pscxCheck = Get-Module -ListAvailable | Where-Object {$_.Name -eq &quot;Pscx&quot;}
$psVer = ($host.version).Major



if (!$pscxCheck)
{
    Write-Host &quot;Installing PSCX...&quot; 
    Copy-Item C:\Tools\Pscx C:\Windows\System32\WindowsPowerShell\v1.0\Modules -Recurse
  
    Start-Sleep -Seconds 30
    Reload-Profile
        
}

Import-Module PowerShellPack
Import-Module Pscx

		$xApp = &quot;&quot;
        $xTask = &quot;&quot;
        $xProj = &quot;&quot;
        $xSA = &quot;&quot;

#Generated Form Function
function GenerateForm {
########################################################################
# Code Generated By: SAPIEN Technologies PrimalForms (Community Edition) v1.0.10.0
# Generated On: 3/14/2013 9:51 AM
# Generated By: deanc4
########################################################################

#region Import the Assemblies
[reflection.assembly]::loadwithpartialname(&quot;System.Windows.Forms&quot;) | Out-Null
[reflection.assembly]::loadwithpartialname(&quot;System.Drawing&quot;) | Out-Null
#endregion

#region Generated Form Objects
$form = New-Object System.Windows.Forms.Form
$exitBtn = New-Object System.Windows.Forms.Button
$okBtn = New-Object System.Windows.Forms.Button
$fileBtn = New-Object System.Windows.Forms.Button
$cleanupCkbx = New-Object System.Windows.Forms.CheckBox
$passTxt = New-Object System.Windows.Forms.TextBox
$passLbl = New-Object System.Windows.Forms.Label
$svcAcctTxt = New-Object System.Windows.Forms.ComboBox
$svcAcctLbl = New-Object System.Windows.Forms.Label
$projShortTxt = New-Object System.Windows.Forms.TextBox
$projShortLbl = New-Object System.Windows.Forms.Label
$taskNameTxt = New-Object System.Windows.Forms.TextBox
$taskNameLbl = New-Object System.Windows.Forms.Label
$appPathTxt = New-Object System.Windows.Forms.TextBox
$appPathLbl = New-Object System.Windows.Forms.Label
$progressBar = New-Object System.Windows.Forms.ProgressBar
$timer1 = New-Object System.Windows.Forms.Timer
$timer2 = New-Object System.Windows.Forms.Timer
$openFileDialog1 = New-Object System.Windows.Forms.OpenFileDialog
$InitialFormWindowState = New-Object System.Windows.Forms.FormWindowState
#endregion Generated Form Objects

#----------------------------------------------
#Generated Event Script Blocks
#----------------------------------------------
#Provide Custom Code for events specified in PrimalForms.

function stepBar
{
    if ($progressBar.Value -lt 100)
    {    
    $progressBar.Increment(1)
    }
    else
    {
    $progressBar.Value = 1
    }
}

$okBtn_OnClick= 
{

$timer1.Interval = 1000
$timer1.add_Tick({stepBar})
$timer1.start()

$xApp=$appPathTxt.Text
$xTask=$taskNameTxt.Text
$xProj=$projShortTxt.Text
$xSA=$svcAcctTxt.Text
$xPass=$passTxt.Text


# Creates the Script Files and Folder Directory (Under C:\Tools)
$newDir = &quot;C:\Tools\&quot;+$xTask
New-Item $newDir -type directory
$scriptRun = $newDir+&quot;\&quot;+$xTask + &quot;.ps1&quot;
$scriptTask = $newDir+&quot;\&quot;+$xTask + &quot;_Task.ps1&quot;
$scriptTaskExe = $newDir+&quot;\&quot;+$xTask + &quot;_Task.exe&quot;
$scriptExe = $newDir+&quot;\&quot;+$xTask + &quot;.exe&quot;
New-Item $scriptRun -type file -force
New-Item $scriptTask -type file -force
if ($winVersion -like &quot;*2003*&quot;)
{
   $taskDir = &quot;C:\WINDOWS\Tasks\&quot;+$xProj
}
else
{
# Creates the Tasks sub-directory
$taskDir = &quot;C:\Windows\System32\Tasks\&quot;+$xProj
}
New-Item $taskDir -type directory -force


#$netuser = $xSA+&quot; &quot;+$password+&quot; /add&quot;
Write-Host &quot;Creating Local User&quot;
net user $xSA $xPass /add
net localgroup administrators /add $xSA

$localGroup = $xProj+&quot;_TaskRunners&quot;

Write-Host &quot;Creating Local Group&quot;
net localgroup $localGroup /add

Write-Host &quot;Setting Permissions&quot;
$cacls = &quot;cacls.exe &quot;+$taskDir+&quot; /T /E /G &quot;+$localGroup+&quot;:R&quot;
Invoke-Expression $cacls

# Copy PSTerminalServices Module
Write-Host &quot;Copying Module&quot;

New-Item C:\Windows\System32\WindowsPowerShell\v1.0\Modules\PSTerminalServices -type directory -Force
Copy-Item C:\Tools\PSTerminalServices\* C:\Windows\System32\WindowsPowerShell\v1.0\Modules\PSTerminalServices\ -Recurse -ErrorAction SilentlyContinue
if ($winVersion -like &quot;*2003*&quot;)
{
$Task = $xTask
$newTask = $scriptTaskExe
}
else
{
$Task = $xProj+&quot;\&quot;+$xTask
$newTask = $scriptTaskExe
}

if ($winVersion -like &quot;*2003*&quot;)
{
SCHTASKS /CREATE /RU $xSA /RP $xPass /TN $Task /TR $newTask /SC ONCE /ST 00:01 /F
}
else
{
New-Task | Add-TaskAction -Path $newTask -WorkingDirectory &quot;&quot; | Register-ScheduledTask $Task 
SCHTASKS /Change /RU $xSA /RP $xPass /TN $Task /RL HIGHEST
}

$tempPath = &quot;C:\Tools\&quot;+$xTask+&quot;\Temp&quot;
New-Item -Type Directory -Path $tempPath

$scriptRunContents = @&quot;
Import-Module PSTerminalServices
`$tempFile`=&quot;C:\Tools\$xTask\Temp\session.tmp&quot;
`$logFile`=&quot;C:\Tools\$xTask\Temp\log.txt&quot;
`$task` = &quot;$Task&quot;
`$user`=whoami
`$user`=`$user`.Split(&quot;\&quot;)[1]

`$getSessions`=Get-TSSession
`$getSessions`=`$getSessions`|Select &quot;SessionID&quot;, &quot;UserName&quot;

`$userSession`=`$getSessions`|Where-Object {`$_.UserName` -eq `$user`}
`$sessionId`=`$userSession.SessionId`

`$sessionId`|Out-File `$tempFile`


schtasks /run /TN $task
&quot;@
Out-File -InputObject $scriptRunContents -FilePath $scriptRun
$cacls = &quot;cacls.exe &quot;+$scriptRun+&quot; /T /E /G &quot;+$localGroup+&quot;:R&quot;
Invoke-Expression $cacls

$cacls = &quot;cacls.exe &quot;+$tempPath+&quot; /T /E /G &quot;+$localGroup+&quot;:C&quot;
Invoke-Expression $cacls

Write-Host &quot;Copying PsExec to System32&quot;
Copy-Item -Path C:\Tools\PsExec.exe C:\Windows\System32\

$scriptTaskContents = @&quot;
Import-Module PSTerminalServices
`$logFile`=&quot;C:\Tools\$xTask\Temp\log.txt&quot;
`$tempFile`=&quot;C:\Tools\$xTask\Temp\session.tmp&quot;
`$psexec`=&quot;PsExec.exe /accepteula&quot;
`$command`=`&quot;cmd /C ```&quot;$xApp```&quot;`&quot;
`$session`=get-content `$tempFile`

`$cmd`=`$psexec`+&quot; -s -d -i &quot;+`$session`+&quot; &quot;+`$command`

Get-Date|Out-File `$logFile` -Append
`$event` = Get-TSSession -SessionID `$session`|Select &quot;SessionID&quot;, &quot;IPAddress&quot;, &quot;UserName&quot;|Format-Table -autosize

Invoke-Expression `$cmd`

Remove-Item `$tempFile`
&quot;@
Out-File -InputObject $scriptTaskContents -FilePath $scriptTask

make-exe $scriptRun $scriptExe C:\Tools\Run.ico
make-exe $scriptTask $scriptTaskExe C:\Tools\Run.ico
$pdbFile = $newDir+&quot;\*.pdb&quot;
$gzFile = $newDir+&quot;\*.gz&quot;
Remove-Item $pdbFile
Remove-Item $gzFile
Remove-Item $scriptRun
Remove-Item $scriptTask

$chkbox = $cleanupCkbx.Checked

if ($chkbox -eq $TRUE)
{
    $PscxFiles = &quot;C:\Tools\Pscx&quot;
    Remove-Item $PscxFiles -Recurse -Force
    $PSTSFiles = &quot;C:\Tools\PSTerminalServices&quot;
    Remove-Item $PSTSFiles -Recurse -Force
    Remove-Item C:\Tools\PowerShellPack.msi -Force
    Remove-Item C:\Tools\Run.ico
    Remove-Item C:\Tools\PsExec.exe
}


$xPass = $NULL
$timer1.Stop()
$form.Close()

}

$handler_form_Load= 
{
$progressBar.Value = 0
$timer1.Stop()
}

$exitBtn_OnClick= 
{
$timer1.Stop()
$form.Close()

}

$fileBtn_OnClick= 
{
$openFileDialog1.ShowDialog()
$appPathTxt.Text = $openFileDialog1.FileName

}



$OnLoadForm_StateCorrection=
{#Correct the initial state of the form to prevent the .Net maximized form issue
	$form.WindowState = $InitialFormWindowState
}
$users = get-wmiobject -class &quot;Win32_UserAccount&quot; -Filter &quot;LocalAccount = True&quot;

foreach ($user in $users)
{
    $svcAcctTxt.Items.Add($user.Name)
}
#----------------------------------------------
#region Generated Form Code
$System_Drawing_Size = New-Object System.Drawing.Size
$System_Drawing_Size.Height = 268
$System_Drawing_Size.Width = 229
$form.ClientSize = $System_Drawing_Size
$form.DataBindings.DefaultDataSourceUpdateMode = 0
$form.Name = &quot;form&quot;
$form.Text = &quot;Deploy RunAsAdmin&quot;
$form.add_Load($handler_form_Load)


$exitBtn.DataBindings.DefaultDataSourceUpdateMode = 0

$System_Drawing_Point = New-Object System.Drawing.Point
$System_Drawing_Point.X = 119
$System_Drawing_Point.Y = 223
$exitBtn.Location = $System_Drawing_Point
$exitBtn.Name = &quot;exitBtn&quot;
$System_Drawing_Size = New-Object System.Drawing.Size
$System_Drawing_Size.Height = 23
$System_Drawing_Size.Width = 98
$exitBtn.Size = $System_Drawing_Size
$exitBtn.TabIndex = 14
$exitBtn.Text = &quot;EXIT&quot;
$exitBtn.UseVisualStyleBackColor = $True
$exitBtn.add_Click($exitBtn_OnClick)

$form.Controls.Add($exitBtn)


$okBtn.DataBindings.DefaultDataSourceUpdateMode = 0

$System_Drawing_Point = New-Object System.Drawing.Point
$System_Drawing_Point.X = 12
$System_Drawing_Point.Y = 223
$okBtn.Location = $System_Drawing_Point
$okBtn.Name = &quot;okBtn&quot;
$System_Drawing_Size = New-Object System.Drawing.Size
$System_Drawing_Size.Height = 23
$System_Drawing_Size.Width = 98
$okBtn.Size = $System_Drawing_Size
$okBtn.TabIndex = 13
$okBtn.Text = &quot;OK&quot;
$okBtn.UseVisualStyleBackColor = $True
$okBtn.add_Click($okBtn_OnClick)

$form.Controls.Add($okBtn)


$fileBtn.DataBindings.DefaultDataSourceUpdateMode = 0

$System_Drawing_Point = New-Object System.Drawing.Point
$System_Drawing_Point.X = 191
$System_Drawing_Point.Y = 19
$fileBtn.Location = $System_Drawing_Point
$fileBtn.Name = &quot;fileBtn&quot;
$System_Drawing_Size = New-Object System.Drawing.Size
$System_Drawing_Size.Height = 20
$System_Drawing_Size.Width = 26
$fileBtn.Size = $System_Drawing_Size
$fileBtn.TabIndex = 12
$fileBtn.Text = &quot;...&quot;
$fileBtn.UseVisualStyleBackColor = $True
$fileBtn.add_Click($fileBtn_OnClick)

$form.Controls.Add($fileBtn)


$cleanupCkbx.DataBindings.DefaultDataSourceUpdateMode = 0

$System_Drawing_Point = New-Object System.Drawing.Point
$System_Drawing_Point.X = 12
$System_Drawing_Point.Y = 200
$cleanupCkbx.Location = $System_Drawing_Point
$cleanupCkbx.Name = &quot;cleanupCkbx&quot;
$System_Drawing_Size = New-Object System.Drawing.Size
$System_Drawing_Size.Height = 16
$System_Drawing_Size.Width = 300
$cleanupCkbx.Size = $System_Drawing_Size
$cleanupCkbx.TabIndex = 11
$cleanupCkbx.Text = &quot;Cleanup source files after completion &quot;
$cleanupCkbx.UseVisualStyleBackColor = $True
$cleanupCkbx.add_CheckedChanged($handler_cleanupCkbx_CheckedChanged)

$form.Controls.Add($cleanupCkbx)

$passTxt.DataBindings.DefaultDataSourceUpdateMode = 0
$passTxt.HideSelection = $False
$System_Drawing_Point = New-Object System.Drawing.Point
$System_Drawing_Point.X = 12
$System_Drawing_Point.Y = 176
$passTxt.Location = $System_Drawing_Point
$passTxt.Name = &quot;passTxt&quot;
$passTxt.PasswordChar = '*'
$System_Drawing_Size = New-Object System.Drawing.Size
$System_Drawing_Size.Height = 20
$System_Drawing_Size.Width = 205
$passTxt.Size = $System_Drawing_Size
$passTxt.TabIndex = 10

$form.Controls.Add($passTxt)

$passLbl.DataBindings.DefaultDataSourceUpdateMode = 0

$System_Drawing_Point = New-Object System.Drawing.Point
$System_Drawing_Point.X = 12
$System_Drawing_Point.Y = 160
$passLbl.Location = $System_Drawing_Point
$passLbl.Name = &quot;passLbl&quot;
$System_Drawing_Size = New-Object System.Drawing.Size
$System_Drawing_Size.Height = 12
$System_Drawing_Size.Width = 205
$passLbl.Size = $System_Drawing_Size
$passLbl.TabIndex = 9
$passLbl.Text = &quot;Service Account Password:&quot;

$form.Controls.Add($passLbl)

$svcAcctTxt.DataBindings.DefaultDataSourceUpdateMode = 0
$svcAcctTxt.FormattingEnabled = $True
$System_Drawing_Point = New-Object System.Drawing.Point
$System_Drawing_Point.X = 12
$System_Drawing_Point.Y = 136
$svcAcctTxt.Location = $System_Drawing_Point
$svcAcctTxt.Name = &quot;svcAcctTxt&quot;
$System_Drawing_Size = New-Object System.Drawing.Size
$System_Drawing_Size.Height = 21
$System_Drawing_Size.Width = 205
$svcAcctTxt.Size = $System_Drawing_Size
$svcAcctTxt.TabIndex = 8

$form.Controls.Add($svcAcctTxt)

$svcAcctLbl.DataBindings.DefaultDataSourceUpdateMode = 0

$System_Drawing_Point = New-Object System.Drawing.Point
$System_Drawing_Point.X = 12
$System_Drawing_Point.Y = 120
$svcAcctLbl.Location = $System_Drawing_Point
$svcAcctLbl.Name = &quot;svcAcctLbl&quot;
$System_Drawing_Size = New-Object System.Drawing.Size
$System_Drawing_Size.Height = 12
$System_Drawing_Size.Width = 205
$svcAcctLbl.Size = $System_Drawing_Size
$svcAcctLbl.TabIndex = 7
$svcAcctLbl.Text = &quot;Service Account Name:&quot;

$form.Controls.Add($svcAcctLbl)

$projShortTxt.DataBindings.DefaultDataSourceUpdateMode = 0
$System_Drawing_Point = New-Object System.Drawing.Point
$System_Drawing_Point.X = 13
$System_Drawing_Point.Y = 97
$projShortTxt.Location = $System_Drawing_Point
$projShortTxt.Name = &quot;projShortTxt&quot;
$System_Drawing_Size = New-Object System.Drawing.Size
$System_Drawing_Size.Height = 20
$System_Drawing_Size.Width = 204
$projShortTxt.Size = $System_Drawing_Size
$projShortTxt.TabIndex = 6

$form.Controls.Add($projShortTxt)

$projShortLbl.DataBindings.DefaultDataSourceUpdateMode = 0

$System_Drawing_Point = New-Object System.Drawing.Point
$System_Drawing_Point.X = 13
$System_Drawing_Point.Y = 81
$projShortLbl.Location = $System_Drawing_Point
$projShortLbl.Name = &quot;projShortLbl&quot;
$System_Drawing_Size = New-Object System.Drawing.Size
$System_Drawing_Size.Height = 12
$System_Drawing_Size.Width = 204
$projShortLbl.Size = $System_Drawing_Size
$projShortLbl.TabIndex = 5
$projShortLbl.Text = &quot;Project Short-Name:&quot;

$form.Controls.Add($projShortLbl)

$taskNameTxt.DataBindings.DefaultDataSourceUpdateMode = 0
$System_Drawing_Point = New-Object System.Drawing.Point
$System_Drawing_Point.X = 13
$System_Drawing_Point.Y = 58
$taskNameTxt.Location = $System_Drawing_Point
$taskNameTxt.Name = &quot;taskNameTxt&quot;
$System_Drawing_Size = New-Object System.Drawing.Size
$System_Drawing_Size.Height = 20
$System_Drawing_Size.Width = 204
$taskNameTxt.Size = $System_Drawing_Size
$taskNameTxt.TabIndex = 4

$form.Controls.Add($taskNameTxt)

$taskNameLbl.DataBindings.DefaultDataSourceUpdateMode = 0

$System_Drawing_Point = New-Object System.Drawing.Point
$System_Drawing_Point.X = 13
$System_Drawing_Point.Y = 42
$taskNameLbl.Location = $System_Drawing_Point
$taskNameLbl.Name = &quot;taskNameLbl&quot;
$System_Drawing_Size = New-Object System.Drawing.Size
$System_Drawing_Size.Height = 12
$System_Drawing_Size.Width = 204
$taskNameLbl.Size = $System_Drawing_Size
$taskNameLbl.TabIndex = 3
$taskNameLbl.Text = &quot;Task Name:&quot;

$form.Controls.Add($taskNameLbl)

$appPathTxt.DataBindings.DefaultDataSourceUpdateMode = 0
$System_Drawing_Point = New-Object System.Drawing.Point
$System_Drawing_Point.X = 13
$System_Drawing_Point.Y = 19
$appPathTxt.Location = $System_Drawing_Point
$appPathTxt.Name = &quot;appPathTxt&quot;
$System_Drawing_Size = New-Object System.Drawing.Size
$System_Drawing_Size.Height = 20
$System_Drawing_Size.Width = 172
$appPathTxt.Size = $System_Drawing_Size
$appPathTxt.TabIndex = 2

$form.Controls.Add($appPathTxt)

$appPathLbl.DataBindings.DefaultDataSourceUpdateMode = 0

$System_Drawing_Point = New-Object System.Drawing.Point
$System_Drawing_Point.X = 12
$System_Drawing_Point.Y = 3
$appPathLbl.Location = $System_Drawing_Point
$appPathLbl.Name = &quot;appPathLbl&quot;
$System_Drawing_Size = New-Object System.Drawing.Size
$System_Drawing_Size.Height = 12
$System_Drawing_Size.Width = 205
$appPathLbl.Size = $System_Drawing_Size
$appPathLbl.TabIndex = 1
$appPathLbl.Text = &quot;Application Path:&quot;

$form.Controls.Add($appPathLbl)

$progressBar.DataBindings.DefaultDataSourceUpdateMode = 0
$progressBar.ForeColor = [System.Drawing.Color]::FromArgb(255,160,160,160)
$System_Drawing_Point = New-Object System.Drawing.Point
$System_Drawing_Point.X = 13
$System_Drawing_Point.Y = 252
$progressBar.Location = $System_Drawing_Point
$progressBar.Name = &quot;progressBar&quot;
$System_Drawing_Size = New-Object System.Drawing.Size
$System_Drawing_Size.Height = 10
$System_Drawing_Size.Width = 205
$progressBar.Size = $System_Drawing_Size
$progressBar.TabIndex = 0

$form.Controls.Add($progressBar)



$openFileDialog1.FileName = &quot;openFileDialog1&quot;
$openFileDialog1.ShowHelp = $True

#endregion Generated Form Code

#Save the initial state of the form
$InitialFormWindowState = $form.WindowState
#Init the OnLoad event to correct the initial state of the form
$form.add_Load($OnLoadForm_StateCorrection)
#Show the Form
$form.ShowDialog()| Out-Null

} #End Function

#Call the Function
GenerateForm

</code></pre>

</div>
			<!-- sidebar? -->
		</div>
		<hr>
		<footer class="blog-footer">
			<p>Generated by Joel &quot;Jaykul&quot; Bennett - 2018</p>
		</footer>
	</div> <!-- /container -->

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="/js/main.js"></script>
    <script src="/js/vendor/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-59988721-1', 'auto');
      ga('send', 'pageview');

      $(function () {
          $('#contentTabs a:first').tab('show')
      })

    </script>
</body>
</html>