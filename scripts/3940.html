
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Sign up for PowerShell.Slack.com">
    <meta name="author" content="AdrianWoodrup">
    <title>Office 365 wasted Lics - PoshCode</title>

    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <style>
        body {
            padding-top: 50px;
            padding-bottom: 20px;
        }
    </style>
</head>
<body>
    <header>
    <nav class="navbar navbar-expand-sm fixed-top navbar-dark bg-dark">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="http://PoshCode.org/">PoshCode</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
            <div id="navbarResponsive" class="collapse navbar-collapse navbar-responsive-collapse navbar-right">
                <ul class="nav navbar-nav nav-tabs ml-auto" data-tabs="tabs" id="tabs">
                    <li class="nav-item"><a class="nav-link active show" href="/scripts" data-toggle="tab">Scripts</a></li>
                    <li class="nav-item"><a class="nav-link" href="/video" data-toggle="tab">Video Feed</a></li>
                </ul>
            </div><!--/.navbar-collapse -->
        </div>
    </nav>
    </header>

    

<div class="blog-post">
    <h2 class="blog-post-title">Office 365 wasted Lics</h2>
    <p class="blog-post-meta">
        <span class="blog-post-time">2013-02-12</span> by <a class="blog-post-author">AdrianWoodrup</a>
    </p>

    <h1>Office 365 wasted Lics</h1>
<h3><a href="//scripts/3940.ps1">download</a></h3>
<p>This Script will create a csv file with all the users that are disabled in AD but still have licenses in Office 365, it will then email the script out and perform a clean up.</p>
<pre><code class="language-posh">$AD = 'C:\temp\ad.csv'
$o365 = 'C:\temp\o365.csv'
$duplicates = 'C:\temp\Duplicate Office 365 users.csv'
$log = 'C:\temp\Duplicate Office 365 users.log'
$PSEmailServer = 'MAILSERVER'
$EmailTo = 'TO-EMAILADDRESS'
$EmailFrom = 'FROM-EMAILADDRESS'

Import-Module ActiveDirectory 
Import-Module MSOnline

$password = ConvertTo-SecureString 'PASSWORD' -AsPlainText -Force
$LiveCred = New-Object System.Management.Automation.PSCredential (&quot;O365-USERNAME&quot;, $password)
New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://ps.outlook.com/powershell/ -Credential $LiveCred -Authentication Basic -AllowRedirection

Connect-MsolService -Credential $Livecred

Search-ADAccount -AccountDisabled | Select-Object UserPrincipalName | where-object {$_.UserPrincipalName -like &quot;*@*&quot; }  | Export-Csv $AD
Get-MsolUser -all | Where-Object { $_.isLicensed -eq &quot;TRUE&quot;} | Select-Object UserPrincipalName | Export-Csv $o365
$Import = Import-Csv $o365
$Import | Out-File -Append $AD -encoding ASCII

$content = Get-Content $AD
$content | Foreach {$_.TrimEnd()} | Set-Content $AD

$RMVQuotes = Get-Content $AD 
$RMVQuotes -replace('&quot;','') | Sort-Object | Out-File $AD -Force
Get-Content $AD | Group-Object -NoElement | Where-Object {$_.Count -gt 1} | Select-Object Count, Name | Export-Csv $duplicates

get-pssession | where-object {$_.ComputerName -Like &quot;*.outlook.com&quot;} | remove-pssession

copy-item $duplicates $log

$DupLic = Import-Csv $duplicates | Measure-Object | Select-Object -Expand count
$subject = &quot;There are &quot; + $DupLic + &quot; office 365 Licenses being used by disabled users&quot;
if ($DupLic -gt 3){
	Send-MailMessage -To $EmailTo -From $EamilFrom -Subject $Subject -attachments $log -Body &quot;There are O365 Licenses being used by disabled users. Please remove theses licenses from Office 365 as each one costs. The attached is a list of all users that have an office 365 license assigned to them but are disabled in AD. Confirm the account and email is not in use and the license can be deleted. &quot;
}

Remove-Item $AD
Remove-Item $o365
Remove-Item $Duplicates
Remove-Item $Log
</code></pre>

</div>

    <footer class="blog-footer">
        <p>&copy; Joel &quot;Jaykul&quot; Bennett 2018</p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="/js/main.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-59988721-1', 'auto');
      ga('send', 'pageview');

      $(function () {
          $('#contentTabs a:first').tab('show')
      })

    </script>
</body>
</html>