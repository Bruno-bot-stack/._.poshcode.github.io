<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Sign up for PowerShell.Slack.com">
    <meta name="author" content="Robin Olsson">
    <title>Get-VeeamRepositoryIP - PoshCode</title>

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/main.css">
    <style>
        body {
            padding-top: 50px;
            padding-bottom: 20px;
        }
    </style>

    <link rel="openid2.provider" href="https://openid.stackexchange.com/openid/provider">
    <link rel="openid2.local_id" href="https://openid.stackexchange.com/user/b167be35-3674-4571-8142-df1f7dcfc268">
<!--
    <link rel="openid2.provider" href="https://www.google.com/accounts/o8/ud" />
    <link rel="openid2.local_id" href="https://profiles.google.com/+JoelBennett" />
-->
</head>
<body>
    <header>
    <nav class="navbar navbar-expand-sm fixed-top navbar-dark bg-dark">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="http://PoshCode.org/">PoshCode</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
            <div id="navbarResponsive" class="collapse navbar-collapse navbar-responsive-collapse navbar-right">
                <ul class="nav navbar-nav nav-tabs ml-auto" data-tabs="tabs" id="tabs">
                    <li class="nav-item"><a class="nav-link active show" href="/Scripts" data-toggle="tab">Scripts</a></li>
                    <li class="nav-item"><a class="nav-link" href="/video" data-toggle="tab">Video Feed</a></li>
                </ul>
            </div><!--/.navbar-collapse -->
        </div>
    </nav>
    </header>

    

<h1>Get-VeeamRepositoryIP</h1>
<h3><a href="//scripts/5707.ps1">download</a></h3>
<p>Used to find Veeam error events where backup failed because of RPC errors [DoRpcWithBinary]. Outputs an array of the unique IP adresses it finds in the eventlog and finally appends the queried Veeamserver to the list</p>
<pre><code class="language-posh">&lt;#
	.SYNOPSIS
		Finds the unique IP(s) of the Veeam repository server(s) that failed to backup one or more virtual servers because of RPC errors.
	
	.DESCRIPTION
		Extracts the unique IP adresses for the Veeam repository servers that report RPC errors in the eventlog
        so it can be used to report an error or pass IP along to a script that restarts the offending machines. 

	.PARAMETER ComputerName
		The computername for the Veeam backupserver that holds the eventlog information.
	
	.PARAMETER StartTime
		Decides how many hours to go back in the eventlog. Default is 24 hours.
	
	.EXAMPLE
				PS C:\&gt; Get-VeeamRepositoryIP -ComputerName vmbackup01 -StartTime 24
	
	.NOTES
		If one or more matches are found then the Veeam backupserver specified in the ComputerName variable is added to the end of the list.
#&gt;
function Get-VeeamRepositoryIP
{
	[CmdletBinding()]
	[OutputType([array])]
	param
	(
		[Parameter(Mandatory = $true,
				   ValueFromPipeline = $true,
				   ValueFromPipelineByPropertyName = $true,
				   Position = 1)]
		[ValidateNotNullOrEmpty()]
		[string]
		$ComputerName,
		[Parameter(Mandatory = $false,
				   Position = 2)]
		[int32]
		$StartTime = 24
	)
	
	Begin
	{
		$STime = (Get-Date).AddHours(-$StartTime)
		# Filter out IPv4 adresses
		$Regex = ‘\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b’
	}
	Process
	{
		try
		{
			[array]$IP = Get-WinEvent -ComputerName $ComputerName -FilterHashtable @{Logname = &quot;Veeam Backup&quot;; ProviderName = &quot;Veeam MP&quot;; ID = &quot;190&quot;; Level = &quot;2&quot;; StartTime = $STime} -ErrorAction Stop | Where-Object { $_.message -like '*`[DoRpcWithBinary]*' } | ForEach-Object { $_.message | Select-String -Pattern $Regex -AllMatches | % { $_.Matches } | % { $_.Value } } | Sort-Object -Unique
		}
		catch
		{
			Write-Error &quot;No event found&quot;
		}
        if ($IP -ne $Null)
        {
            $IP += $ComputerName
        }
	}
	End
	{
		return $IP
	}
}

</code></pre>

    <footer class="blog-footer">
        <p>© Joel "Jaykul" Bennett 2018.</p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="js/main.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-59988721-1', 'auto');
      ga('send', 'pageview');

      $(function () {
          $('#contentTabs a:first').tab('show')
      })

    </script>
</body>
</html>