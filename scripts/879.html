
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Sign up for PowerShell.Slack.com">
    <meta name="author" content="Rob Campbell">
    <title>Timespan SMTP Headers - PoshCode</title>

    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <style>
        body {
            padding-top: 50px;
            padding-bottom: 20px;
        }
    </style>
</head>
<body>
    <header>
    <nav class="navbar navbar-expand-sm fixed-top navbar-dark bg-dark">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="http://PoshCode.org/">PoshCode</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
            <div id="navbarResponsive" class="collapse navbar-collapse navbar-responsive-collapse navbar-right">
                <ul class="nav navbar-nav nav-tabs ml-auto" data-tabs="tabs" id="tabs">
                    <li class="nav-item"><a class="nav-link active show" href="/scripts" data-toggle="tab">Scripts</a></li>
                    <li class="nav-item"><a class="nav-link" href="/video" data-toggle="tab">Video Feed</a></li>
                </ul>
            </div><!--/.navbar-collapse -->
        </div>
    </nav>
    </header>

    

<div class="blog-post">
    <h2 class="blog-post-title">Timespan SMTP Headers</h2>
    <p class="blog-post-meta">
        <span class="blog-post-time">2009-02-17</span> by <a class="blog-post-author">Rob Campbell</a>
    </p>

    <h1>Timespan SMTP Headers</h1>
<h3><a href="//scripts/879.ps1">download</a></h3>
<p>This reads in a set of SMTP headers, and displays the MTA's the message passed through, in chronological order, and calculates and displays the message latency (time it spent there) between each one.  The latency for the first received header as well as the total message time is calculated from the Date: header timestamp on the email.  MTAs with out-of-sync clocks should show up as negative latencies, or a mismatch between the accumulated lantencies and the calculated total time.</p>
<pre><code class="language-posh">$hdr_txt = gc ./hdr.txt

$rec_hdr_regex = [regex]&quot;^Received\:\sfrom\s(.+?)\sby\s(.+?)\;\s(.+?\d\d\:\d\d\:\d\d\s[+|-]\d{4})&quot;


$from_hdr = $hdr_txt | select-string &quot;^From\:\s.+$&quot;
$rec_block = $hdr_txt[0..$($from_hdr.linenumber -2)]
$rec_lines = $rec_block | select-string &quot;^Received\:\sfrom&quot;
$sent_hdr = $hdr_txt | select-string &quot;^Date\:\s.+$&quot;
$sent_hdr.line -match &quot;^Date\:\s(.+)$&quot; &gt; $nul
$sent_ts = [datetime]$matches[1]

foreach ($rec_line in $rec_lines[1..$($rec_lines.count -1)]){$rec_block[$rec_line.linenumber -1] = &quot;~&quot; + $rec_line.line}
$rec_hdrs  = $([string]$rec_block).split(&quot;~&quot;)


Write-host &quot;`nMessage sent $($sent_ts)`n&quot;

$i = $rec_hdrs.count -1
$last_ts = $sent_ts

while ($i -ge 0) {
$rec_hdrs[$i] -match $rec_hdr_regex &gt; $nul
$rec_ts = [datetime]$matches[3] 
$latency = $rec_ts - $last_ts
$last_ts = $rec_ts
write-host &quot;latency is $($latency.totalseconds) seconds`n&quot;
write-host $matches[1]   
$i--
}

Write-host &quot;`nMessage received $($last_ts)&quot;
write-host &quot;Total time is $($($last_ts - $sent_ts).seconds) seconds.`n&quot;

</code></pre>

</div>

    <footer class="blog-footer">
        <p>&copy; Joel &quot;Jaykul&quot; Bennett 2018</p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="/js/main.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-59988721-1', 'auto');
      ga('send', 'pageview');

      $(function () {
          $('#contentTabs a:first').tab('show')
      })

    </script>
</body>
</html>