<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Sign up for PowerShell.Slack.com">
    <meta name="author" content="monahancj">
    <title>VMware sVmotion throttle - PoshCode</title>

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/main.css">
    <style>
        body {
            padding-top: 50px;
            padding-bottom: 20px;
        }
    </style>

    <link rel="openid2.provider" href="https://openid.stackexchange.com/openid/provider">
    <link rel="openid2.local_id" href="https://openid.stackexchange.com/user/b167be35-3674-4571-8142-df1f7dcfc268">
<!--
    <link rel="openid2.provider" href="https://www.google.com/accounts/o8/ud" />
    <link rel="openid2.local_id" href="https://profiles.google.com/+JoelBennett" />
-->
</head>
<body>
    <header>
    <nav class="navbar navbar-expand-sm fixed-top navbar-dark bg-dark">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="http://PoshCode.org/">PoshCode</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
            <div id="navbarResponsive" class="collapse navbar-collapse navbar-responsive-collapse navbar-right">
                <ul class="nav navbar-nav nav-tabs ml-auto" data-tabs="tabs" id="tabs">
                    <li class="nav-item"><a class="nav-link active show" href="/Scripts" data-toggle="tab">Scripts</a></li>
                    <li class="nav-item"><a class="nav-link" href="/video" data-toggle="tab">Video Feed</a></li>
                </ul>
            </div><!--/.navbar-collapse -->
        </div>
    </nav>
    </header>

    

<h1>VMware sVmotion throttle</h1>
<h3><a href="//scripts/4880.ps1">download</a></h3>
<p>Wait function to pause a script loop until the number of sVmotions is below the specified number.  For VMware, but easy to convert I would think.</p>
<pre><code class="language-posh">&lt;#
	.SYNOPSIS
		Will enter a wait/loop if there are running vMotion or svMotion tasks.
	.DESCRIPTION
		Checks the tasks and counts the number running vMotion or svMotion tasks.
		If the number of active tasks is greater than the specified limit
		then the function sleeps and checks again. The intended is as a throttle
		in large (s)vMotion loops to prevent overloading the environment.  Is
		especially useful in throttling a script while an unrelated event happens, 
		such as putting a host or datastore into maintenance mode.
	.PARAMETER vMotionLimit
		The active tasks to test for.  If the number of active tasks is less than
		this the function will exit.  The default is 1, and must be an integer.
	.PARAMETER DelayMinutes
		How long to wait before checking the active tasks again.  The default 
		is 1, and must be an integer.
	.EXAMPLE
		Wait-mTaskvMotions -Verbose
	.EXAMPLE
		Wait-mTaskvMotions -vMotionLimit 4
	.EXAMPLE
		Wait-mTaskvMotions -vMotionLimit 2 -DelayMinutes 3 -Verbose
	.NOTES
		Using -Verbose will output standard script started and finished messages, 
		and how long the function will sleep before it checks the active tasks again.
	.LINK
		http://mongit201.be.monster.com/chrism/virtech/blob/master/Repo/Wait-mTaskvMotions.ps1
#&gt;

function Wait-mTaskvMotions {
[CmdletBinding()]
Param(
	[int] $vMotionLimit=1,
	[int] $DelayMinutes=5
)

$NumvMotionTasks = (Get-Task | ? { ($_.PercentComplete -ne 100) -and ( ($_.Description -like '*DRS*') -or ($_.Description -like '*vMotion*') )} | Measure-Object).Count

While ( $NumvMotionTasks -ge $vMotionLimit ) {
  Write-Verbose &quot;$(Get-Date)- Waiting $($DelayMinutes) minute(s) before checking again.&quot;
  Start-Sleep ($DelayMinutes * 60)
  $NumvMotionTasks = (Get-Task | ? { ($_.PercentComplete -ne 100) -and ( ($_.Description -like '*DRS*') -or ($_.Description -like '*vMotion*') )} | Measure-Object).Count
}
Write-Verbose &quot;$(Get-Date)- Proceeding.&quot;
} # end function


</code></pre>

    <footer class="blog-footer">
        <p>Â© Joel "Jaykul" Bennett 2018.</p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="js/main.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-59988721-1', 'auto');
      ga('send', 'pageview');

      $(function () {
          $('#contentTabs a:first').tab('show')
      })

    </script>
</body>
</html>