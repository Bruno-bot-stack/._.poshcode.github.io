
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Sign up for PowerShell.Slack.com">
    <meta name="author" content="Geoff Guynn">
    <title>Anmin Launcher (v2!) - PoshCode</title>

    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <style>
        body {
            padding-top: 50px;
            padding-bottom: 20px;
        }
    </style>
</head>
<body>
    <header>
    <nav class="navbar navbar-expand-sm fixed-top navbar-dark bg-dark">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="http://PoshCode.org/">PoshCode</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
            <div id="navbarResponsive" class="collapse navbar-collapse navbar-responsive-collapse navbar-right">
                <ul class="nav navbar-nav nav-tabs ml-auto" data-tabs="tabs" id="tabs">
                    <li class="nav-item"><a class="nav-link active show" href="/scripts" data-toggle="tab">Scripts</a></li>
                    <li class="nav-item"><a class="nav-link" href="/video" data-toggle="tab">Video Feed</a></li>
                </ul>
            </div><!--/.navbar-collapse -->
        </div>
    </nav>
    </header>

    

<div class="blog-post">
    <h2 class="blog-post-title">Anmin Launcher (v2!)</h2>
    <p class="blog-post-meta">
        <span class="blog-post-time">2015-09-26</span> by <a class="blog-post-author">Geoff Guynn</a>
    </p>

    <h1>Anmin Launcher (v2!)</h1>
<h3><a href="//scripts/6030.ps1">download</a> - <a href="//scripts/6029.md">parent</a></h3>
<p>I fixed a few major problems I noticed in the original version.</p>
<ol>
<li>The launcher couldn't properly elevate AND run as a different user when passed credentials, so I completely rewrote the event_Click_ProgramButton function to fix this.</li>
<li>The domain information was not properly automatically gathering in some enterprise configurations, so I modified that function to do a more thorough check and added better error handling.</li>
<li>I refactored the code to be more friendly when you press Ctrl+M in ISE. This should make it much easier to get around and see functions, objects, etc at a glance if you're thinking of modifying things.</li>
</ol>
<pre><code class="language-posh">&lt;# Begin ---- Global Variables - Script Limited Scope ---- #&gt;
#Script Author Information
$script:ProgramName = &quot;Admin Launcher&quot;
$script:ProgramDate = &quot;4 Oct 2011&quot;
$script:ProgramAuthor = &quot;Geoffrey Guynn&quot;
$script:ProgramAuthorEmail = [System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String(&quot;Z2VvZmZyZXlAZ3V5bm4ub3Jn&quot;))

#Configuration Variables
$script:xmlConfig = New-Object System.Data.DataSet(&quot;AdminLauncher&quot;)
$script:xmlConfigFile = &quot;$Env:AppData\AdminLauncher\config.xml&quot;

#Script Information
$script:WorkingFileName = $MyInvocation.MyCommand.Definition
$script:WorkingDirectory = Split-Path $script:WorkingFileName -Parent
$script:ScriptVersion = &quot;2.0.1.0&quot;

#Password Container (to keep plaintext passwords out of memory)
$script:SecurePassword = New-Object System.Security.SecureString
&lt;# End ---- Global Variables - Script Limited Scope ---- #&gt;

&lt;# Begin ---- Debugging Options ---- #&gt;
#DebugPreference - SilentlyContinue is the default.
$script:DebugPreference = &quot;SilentlyContinue&quot;
#ErrorActionPreference - Continue is the default.
$Script:ErrorActionPreference = &quot;Continue&quot;
&lt;# End ---- Debugging Options ---- #&gt;

&lt;# Begin ---- Startup Checks ---- #&gt;
Function IsAdmin{ #Is the current user an administrator
    $id = [System.Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object System.Security.Principal.WindowsPrincipal($id)
    return $principal.IsInRole([System.Security.Principal.WindowsBuiltInRole]::Administrator)
}
Function RestartScript{ #Restart the script.
    param(
		[string]$Verb = &quot;open&quot;
	)
    $ProcessStartInfo = New-Object System.Diagnostics.ProcessStartInfo
    $ProcessStartInfo.UseShellExecute = $True
    $ProcessStartInfo.WorkingDirectory = $script:WorkingDirectory
    $ProcessStartInfo.FileName =  &quot;powershell.exe&quot;
    $ProcessStartInfo.Arguments = &quot;-version `&quot;2.0`&quot; -sta -NonInteractive -noLogo -WindowStyle `&quot;Hidden`&quot; -ExecutionPolicy `&quot;Unrestricted`&quot; -file `&quot;$script:WorkingFileName`&quot;&quot;
    $ProcessStartInfo.Verb = $verb
    $ProcessStartInfo.WindowStyle = &quot;Hidden&quot;
    
    #Debug Options - Disable under normal execution.
    if($script:DebugPreference -ne &quot;SilentlyContinue&quot;){
		$ProcessStartInfo.Arguments = &quot;-version `&quot;2.0`&quot; -sta -ExecutionPolicy `&quot;Unrestricted`&quot; -file `&quot;$script:WorkingFileName`&quot;&quot;
		$ProcessStartInfo.WindowStyle = &quot;Normal&quot;
	}	
	
	try{
        $Process = [System.Diagnostics.Process]::Start($ProcessStartInfo)
    }
    catch [System.ComponentModel.Win32Exception]{
    }
}
Function LoadCheck{
    $verb = $Null
    #The GUI requires a single thread apartmentstate configuration.
    if($host.Runspace.ApartmentState -ne [System.Threading.ApartmentState]::STA){
        $Verb = &quot;open&quot;
    }
	#The script could break under powershell version 3.
	if ($host.version.major -ne 2){ #Restart powershell with version 2.0
		$Verb = &quot;open&quot;
	}
    #Check to see if the launcher is running under an elevated token. This is a UAC check.
    if (-not(IsAdmin)){
        $Verb = &quot;runas&quot;
    }
    #If one of the conditions above was true, re-launch the application to fix the problem.
    if ($Verb -ne $Null){
        RestartScript $Verb
        #Terminate the old script, so it doesn't load another launcher.
        break
    }
}
#Run the loadcheck function.
LoadCheck
&lt;# End ---- Startup Checks ---- #&gt;

&lt;# Begin ---- Import Global Objects ---- #&gt;
#The old &quot;LoadWithPartialName&quot; can break in the future, Add-Type is the recommended best practice.
#[void] [System.Reflection.Assembly]::LoadWithPartialName(&quot;System.Windows.Forms&quot;)
#[void] [System.Reflection.Assembly]::LoadWithPartialName(&quot;System.Drawing&quot;)
Add-Type -AssemblyName &quot;System.Windows.Forms&quot;
Add-Type -AssemblyName &quot;System.Drawing&quot;
&lt;# End ---- Import Global Objects ---- #&gt;

&lt;# Begin ---- Windows Forms Object Declarations - Main Form ---- #&gt;
$form_MainLauncher = New-Object System.Windows.Forms.Form
$tlp_Main = New-Object System.Windows.Forms.TableLayoutPanel
$cb_Main_Domain = New-Object System.Windows.Forms.ComboBox
#$ep_Main = New-Object System.Windows.Forms.ErrorProvider
$gb_Main_Programs = New-Object System.Windows.Forms.GroupBox
$gb_Main_RunAs = New-Object System.Windows.Forms.GroupBox
$lbl_Main_Domain = New-Object System.Windows.Forms.Label
$lbl_Main_Password = New-Object System.Windows.Forms.Label
$lbl_Main_UserName = New-Object System.Windows.Forms.Label
$ms_Main_MenuStrip = New-Object System.Windows.Forms.MenuStrip
$mtb_Main_Password = New-Object System.Windows.Forms.MaskedTextBox
$ss_Main_StatusStrip = New-Object System.Windows.Forms.StatusStrip
$tb_Main_UserName = New-Object System.Windows.Forms.TextBox
$tsmi_Main_Configure = New-Object System.Windows.Forms.ToolStripMenuItem
$tsmi_Main_Exit = New-Object System.Windows.Forms.ToolStripMenuItem
$tsmi_Main_Export = New-Object System.Windows.Forms.ToolStripMenuItem
$tsmi_Main_File = New-Object System.Windows.Forms.ToolStripMenuItem
$tsmi_Main_Import = New-Object System.Windows.Forms.ToolStripMenuItem
$tsmi_Main_Reset = New-Object System.Windows.Forms.ToolStripMenuItem
$tssl_Main_StatusStripLabel = New-Object System.Windows.Forms.ToolStripStatusLabel
$tt_Main_Tooltip = New-Object System.Windows.Forms.Tooltip
&lt;# End ---- Windows Forms Object Declarations - Main Form ---- #&gt;

&lt;# Begin ---- Windows Forms Object Declarations - Config Form ---- #&gt;
$form_Config = New-Object System.Windows.Forms.Form
$tlp_Config = New-Object System.Windows.Forms.TableLayoutPanel
$btn_Config_Done = New-Object System.Windows.Forms.Button
$gb_Config_Programs = New-Object System.Windows.Forms.GroupBox

#Programs Datagridview
$dgv_Config_Programs = New-Object System.Windows.Forms.DataGridView
$dgc_Config_Arguments = New-Object System.Windows.Forms.DataGridViewTextBoxColumn
$dgc_Config_Command = New-Object System.Windows.Forms.DataGridViewTextBoxColumn
$dgc_Config_Name = New-Object System.Windows.Forms.DataGridViewTextBoxColumn
&lt;# End ---- Windows Forms Object Declarations - Config Form ---- #&gt;

&lt;# Begin ---- Windows Forms Object Declarations - Dialogs ---- #&gt;
$dlg_OpenFile = New-Object System.Windows.Forms.OpenFileDialog
$dlg_SaveFile = New-Object System.Windows.Forms.SaveFileDialog
&lt;# End ---- Windows Forms Object Declarations - Dialogs ---- #&gt;

&lt;# Begin ---- Windows Form Objects - Suspend Layouts ---- #&gt;
$form_MainLauncher.SuspendLayout()
$form_Config.SuspendLayout()
$tlp_Main.SuspendLayout()
$tlp_Config.SuspendLayout()
$gb_Main_Programs.SuspendLayout()
$gb_Main_RunAs.SuspendLayout()
$gb_Config_Programs.SuspendLayout()
$ss_Main_StatusStrip.SuspendLayout()
$ms_Main_MenuStrip.SuspendLayout()
&lt;# End ---- Windows Form Objects - Suspend Layouts ---- #&gt;

&lt;# Begin ---- Object Definitions - Main Form ---- #&gt;
$form_MainLauncher | % {
    $_.AutoScaleDimensions = New-Object System.Drawing.SizeF(6, 13)
    $_.AutoScaleMode = [System.Windows.Forms.AutoScaleMode]::Font
    $_.Autosize = $True
    $_.BackColor = [System.Drawing.SystemColors]::Control
    $_.Controls.Add($tlp_Main)
    $_.Controls.Add($ss_Main_StatusStrip)
    $_.Controls.Add($ms_Main_MenuStrip)
    $_.MainMenuStrip = $ms_Main_MenuStrip
    $_.MaximumSize = New-Object System.Drawing.Size(275, [System.Windows.Forms.Screen]::PrimaryScreen.Bounds.Height)
    $_.MinimumSize = New-Object System.Drawing.Size(275, 194)
    $_.Name = &quot;form_MainLauncher&quot;
    $_.Size = New-Object System.Drawing.Size(275, 194)
    $_.Text = &quot;Admin Launcher&quot;
    $_.TopMost = $True
}
$tlp_Main | % {
	$_.Autosize = $True
	$_.AutosizeMode = [System.Windows.Forms.AutoSizeMode]::GrowAndShrink
	$_.BackColor = [System.Drawing.SystemColors]::GradientInactiveCaption
	$_.ColumnCount = 1
	$_.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent, 100))) | Out-Null
	$_.Controls.Add($gb_Main_Programs, 0, 1)
	$_.Controls.Add($gb_Main_RunAs, 0, 0)
	$_.Dock = [System.Windows.Forms.DockStyle]::Fill
	$_.Location = New-Object System.Drawing.Point(0, 24)
	$_.Name = &quot;tlp_Main&quot;
	$_.RowCount = 2;
	$_.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute, 109))) | Out-Null
	$_.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Percent, 100))) | Out-Null
	$_.Size = New-Object System.Drawing.Size(259, 295)
	$_.TabIndex = 9
}
$cb_Main_Domain | % {
	$tt_Main_Tooltip.SetToolTip($_, &quot;Select a domain from the list.&quot;) | Out-Null
	$_.Anchor =([System.Windows.Forms.AnchorStyles]::Top -bor [System.Windows.Forms.AnchorStyles]::Left -bor [System.Windows.Forms.AnchorStyles]::Right)
	$_.DropDownStyle = [System.Windows.Forms.ComboBoxStyle]::DropDownList
	$_.FormattingEnabled = $True
	$_.Location = New-Object System.Drawing.Point(58, 71)
	$_.Name = &quot;cb_Main_Domain&quot;
	$_.Size = New-Object System.Drawing.Size(189, 21)
	$_.TabIndex = 4
}
$gb_Main_Programs | % {
	$_.Autosize = $True
	$_.AutosizeMode = [System.Windows.Forms.AutoSizeMode]::GrowAndShrink
	$_.Dock = [System.Windows.Forms.DockStyle]::Fill
	$_.Location = New-Object System.Drawing.Point(3, 112)
	$_.Name = &quot;gb_Main_Programs&quot;
	$_.Size = New-Object System.Drawing.Size(253, 180)
	$_.TabIndex = 9
	$_.TabStop = $False
	$_.Text = &quot;Programs&quot;
}
$gb_Main_RunAs | % {
	$_.Controls.Add($lbl_Main_Domain)
	$_.Controls.Add($cb_Main_Domain)
	$_.Controls.Add($mtb_Main_Password)
	$_.Controls.Add($tb_Main_UserName)
	$_.Controls.Add($lbl_Main_Password)
	$_.Controls.Add($lbl_Main_UserName)
	$_.Dock = [System.Windows.Forms.DockStyle]::Fill
	$_.Location = New-Object System.Drawing.Point(3, 3)
	$_.Name = &quot;gb_Main_RunAs&quot;
	$_.Size = New-Object System.Drawing.Size(253, 103)
	$_.TabIndex = 10
	$_.TabStop = $False
	$_.Text = &quot;Run-As Credentials&quot;
}
$lbl_Main_Domain | % {
	$_.Location = New-Object System.Drawing.Point(6, 74)
	$_.Name = &quot;lbl_Main_Domain&quot;
	$_.Size = New-Object System.Drawing.Size(46, 13)
	$_.TabIndex = 5
	$_.Text = &quot;Domain&quot;
}
$lbl_Main_Password | % {
	$_.Location = New-Object System.Drawing.Point(6, 48)
	$_.Name = &quot;lbl_Main_Password&quot;
	$_.Size = New-Object System.Drawing.Size(56, 13)
	$_.TabIndex = 1
	$_.Text = &quot;Password:&quot;
}
$lbl_Main_UserName | % {
	$_.Location = New-Object System.Drawing.Point(6, 22)
	$_.Name = &quot;lbl_Main_UserName&quot;
	$_.Size = New-Object System.Drawing.Size(60, 13)
	$_.TabIndex = 0
	$_.Text = &quot;UserName:&quot;
}
$ms_Main_MenuStrip | % {
	$_.BackColor = [System.Drawing.SystemColors]::Control
	$_.Items.Add($tsmi_Main_File) | Out-Null
	$_.Location = New-Object System.Drawing.Point(0, 0)
	$_.Name = &quot;ms_Main_MenuStrip&quot;
	$_.RenderMode = [System.Windows.Forms.ToolStripRenderMode]::System
	$_.Size = New-Object System.Drawing.Size(259, 24)
	$_.TabIndex = 3
	$_.Text = $Null
}
$mtb_Main_Password | % {
	$tt_Main_Tooltip.SetToolTip($_, &quot;Enter a password.&quot;) | Out-Null
	$_.Anchor =([System.Windows.Forms.AnchorStyles]::Top -bor [System.Windows.Forms.AnchorStyles]::Left -bor [System.Windows.Forms.AnchorStyles]::Right)
	$_.Location = New-Object System.Drawing.Point(68, 45)
	$_.Name = &quot;mtb_Main_Password&quot;
	$_.PasswordChar = '*'
	$_.Size = New-Object System.Drawing.Size(179, 20)
	$_.TabIndex = 3
}
$ss_Main_StatusStrip | % {
	$_.BackColor = [System.Drawing.SystemColors]::Control
	$_.Items.Add($tssl_Main_StatusStripLabel) | Out-Null
	$_.Location = New-Object System.Drawing.Point(0, 319)
	$_.Name = &quot;ss_Main_StatusStrip&quot;
	$_.Size = New-Object System.Drawing.Size(259, 22)
	$_.TabIndex = 2
	$_.Text = $Null
}
$tb_Main_UserName | % {
	$tt_Main_Tooltip.SetToolTip($_, &quot;Enter a username.&quot;) | Out-Null
	$_.Anchor =([System.Windows.Forms.AnchorStyles]::Top -bor [System.Windows.Forms.AnchorStyles]::Left -bor [System.Windows.Forms.AnchorStyles]::Right)
	$_.Location = New-Object System.Drawing.Point(72, 19)
	$_.Name = &quot;tb_Main_UserName&quot;
	$_.Size = New-Object System.Drawing.Size(175, 20)
	$_.TabIndex = 2

}
$tsmi_Main_Configure | % {
	$_.Name = &quot;tsmi_Main_Configure&quot;
	$_.Size = New-Object System.Drawing.Size(155, 22)
	$_.Text = &quot;Configure&quot;
}
$tsmi_Main_Exit | % {
	$_.Name = &quot;tsmi_Main_Exit&quot;
	$_.Size = New-Object System.Drawing.Size(155, 22)
	$_.Text = &quot;Exit&quot;
}
$tsmi_Main_Export | % {
	$_.Name = &quot;tsmi_Main_Export&quot;
	$_.Size = New-Object System.Drawing.Size(155, 22)
	$_.Text = &quot;Export Settings&quot;
}
$tsmi_Main_File | % {
	$_.DropDownItems.AddRange([System.Windows.Forms.ToolStripItem[]](
		$tsmi_Main_Configure,
		$tsmi_Main_Import,
		$tsmi_Main_Export,
		$tsmi_Main_Reset,
		$tsmi_Main_Exit
	))
	$_.Name = &quot;fileToolStripMenuItem&quot;
	$_.Size = New-Object System.Drawing.Size(37, 20)
	$_.Text = &quot;File&quot;
}
$tsmi_Main_Import | % {
	$_.Name = &quot;tsmi_Main_Import&quot;
	$_.Size = New-Object System.Drawing.Size(155, 22)
	$_.Text = &quot;Import Settings&quot;
}
$tsmi_Main_Reset | % {
	$_.Name = &quot;tsmi_Main_Reset&quot;
	$_.Size = New-Object System.Drawing.Size(155, 22)
	$_.Text = &quot;Reset Default Settings&quot;
}
$tssl_Main_StatusStripLabel | % {
	$_.BackColor = [System.Drawing.SystemColors]::Control
	$_.Name = &quot;tssl_Main_StatusStripLabel&quot;
	$_.Size = New-Object System.Drawing.Size(118, 17)
	$_.Text = $Null
}
&lt;# End ---- Object Definitions - Main Form ---- #&gt;

&lt;# Begin ---- Object Definitions - Config Form ---- #&gt;
$form_Config | % {
	$_.AutoScaleDimensions = New-Object System.Drawing.SizeF(6, 13)
	$_.AutoScaleMode = [System.Windows.Forms.AutoScaleMode]::Font
	$_.ClientSize = New-Object System.Drawing.Size(472, 375)
	$_.Controls.Add($tlp_Config)
	$_.MinimumSize = New-Object System.Drawing.Size(825, 450)
	$_.Name = &quot;form_Config&quot;
	$_.Text = &quot;Config - The script will save new rows and update the launcher if the entry has a name and command.&quot;
	$_.TopMost = $True
}
$tlp_Config | % {
	$_.BackColor = [System.Drawing.SystemColors]::GradientInactiveCaption
	$_.ColumnCount = 4
	$_.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent, 100))) | Out-Null
	$_.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Absolute, 75))) | Out-Null
	$_.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Absolute, 75))) | Out-Null
	$_.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Absolute, 75))) | Out-Null
	$_.Controls.Add($gb_Config_Programs, 0, 0)
	$_.Controls.Add($btn_Config_Done, 3, 1)
	$_.Dock = [System.Windows.Forms.DockStyle]::Fill
	$_.Location = New-Object System.Drawing.Point(0, 0)
	$_.Name = &quot;tlp_Config&quot;
	$_.RowCount = 2
	$_.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Percent, 100))) | Out-Null
	$_.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute, 27))) | Out-Null
	$_.Size = New-Object System.Drawing.Size(472, 375)
	$_.TabIndex = 0
}
$btn_Config_Done | % {
	$_.Anchor = [System.Windows.Forms.AnchorStyles]::Left
	$_.BackColor = [System.Drawing.SystemColors]::Control
	$_.Location = New-Object System.Drawing.Point(400, 351)
	$_.Name = &quot;btn_Config_Done&quot;
	$_.Size = New-Object System.Drawing.Size(69, 21)
	$_.TabIndex = 1
	$_.Text = &quot;Done&quot;
	$_.UseVisualStyleBackColor = $True
}
$gb_Config_Programs | % {
	$tlp_Config.SetColumnSpan($_, 4)
	$_.Controls.Add($dgv_Config_Programs)
	$_.Dock = [System.Windows.Forms.DockStyle]::Fill
	$_.Location = New-Object System.Drawing.Point(3, 3)
	$_.Name = &quot;gb_Config_Programs&quot;
	$_.Size = New-Object System.Drawing.Size(1, 1)
	$_.TabIndex = 0
	$_.TabStop = $False
	$_.Text = &quot;Programs&quot;
}

#Programs Datagridview
$dgv_Config_Programs | % {
	$_.AutoSizeColumnsMode = [System.Windows.Forms.DataGridViewAutoSizeColumnsMode]::Fill
	$_.BackgroundColor = [System.Drawing.SystemColors]::GradientInactiveCaption
	$_.ColumnHeadersHeightSizeMode = [System.Windows.Forms.DataGridViewColumnHeadersHeightSizeMode]::AutoSize
	$_.Columns.AddRange([System.Windows.Forms.DataGridViewColumn[]]($dgc_Config_Name,$dgc_Config_Command, $dgc_Config_Arguments)) | Out-Null
	$_.Dock = [System.Windows.Forms.DockStyle]::Fill
	$_.Location = New-Object System.Drawing.Point(3, 16)
	$_.Name = &quot;dgv_Config_Programs&quot;
	$_.RowHeadersVisible = $False
	$_.SelectionMode = [System.Windows.Forms.DataGridViewSelectionMode]::FullRowSelect
	$_.Size = New-Object System.Drawing.Size(850, 400)
	$_.TabIndex = 0
}
$dgc_Config_Arguments | % {
	$_.AutoSizeMode = [System.Windows.Forms.DataGridViewAutoSizeColumnMode]::Fill
	$_.DataPropertyName = &quot;Arguments&quot;
	$_.FillWeight = 35
	$_.HeaderText = &quot;Arguments&quot;
	$_.Name = &quot;dgc_Config_Arguments&quot;
}
$dgc_Config_Command | % {
	$_.AutoSizeMode = [System.Windows.Forms.DataGridViewAutoSizeColumnMode]::Fill
	$_.DataPropertyName = &quot;Command&quot;
	$_.FillWeight = 60
	$_.HeaderText = &quot;Command&quot;
	$_.Name = &quot;dgc_Config_Command&quot;
}
$dgc_Config_Name | % {
	$_.AutoSizeMode = [System.Windows.Forms.DataGridViewAutoSizeColumnMode]::Fill
	$_.DataPropertyName = &quot;Name&quot;
	$_.FillWeight = 20
	$_.HeaderText = &quot;Name&quot;
	$_.Name = &quot;dgc_Config_Name&quot;
}
&lt;# End ---- Object Definitions - Config Form ---- #&gt;

&lt;# Begin ---- Object Definitions - Dialogs ---- #&gt;
$dlg_OpenFile | % {
	$_.InitialDirectory = &quot;$env:USERPROFILE\Documents&quot;
	$_.Filter = &quot;Xml Document(*.xml)|*.xml&quot;
}
$dlg_SaveFile | % {
	$_.InitialDirectory = &quot;$env:USERPROFILE\Documents&quot;
	$_.Filter = &quot;Xml Document(*.xml)|*.xml&quot;
	$_.FileName = &quot;AdminLauncher_Settings.xml&quot;
}
&lt;# End ---- Object Definitions - Dialogs ---- #&gt;

&lt;# Begin ---- Admin Launcher Helper Functions ---- #&gt;
Function Add-Program{
    param(
        [System.Data.DataSet]$DataSet
        , #The name of the program
        [String]$Name
        , #The command for the program
        [string]$Command = $Null
        , #Any arguments required by the program
        [string]$Arguments = $Null
    )
    $htProgram = @{
        DataSet = $DataSet
        TableName = &quot;Programs&quot;
        RowData = @{
            Name = $Name
            Command = $Command
            Arguments = $Arguments
        }
    }
    
    Add-Row @htProgram
}
Function Add-ProgramButtons{
	#Suspend layouts so the screen doesn't flicker as each element is removed and then added.
    $form_MainLauncher.SuspendLayout()
    $gb_Main_Programs.SuspendLayout()
	
    while ($gb_Main_Programs.haschildren){ #Remove all old programs. Disposing them avoids a memory leak as the objects are recreated.
        $gb_Main_Programs.controls | % {
            $_.Dispose()
            $gb_Main_Programs.Controls.Remove($_)
        }
    }
    #Sort the list of programs by name, then create a button for each one.
    foreach ($Program in $script:xmlconfig.Tables[&quot;Programs&quot;].Select($Null, &quot;Name Asc&quot;)){
        if ($gb_Main_Programs.HasChildren){#As we add buttons, we need to find the lowest one and properly offset by 22 from it. We'll sort the buttons by their y coordinate and calculate the lowest on each iteration.
            $yCoordinate = (@($gb_Main_Programs.Controls | Sort-Object @{Expression={$_.location.Y}} -descending)[0].Location.Y) + 22
        }
        else{ #The offset we'd use for our first button.
			$yCoordinate = 16
		}
		
        #Generate tooltip information.
        $tt_Main_TooltipString = &quot;Launch $($Program.Name)&quot;
        if (![DBNull]::Value.Equals($Program.Command) -and $Program.Command){$tt_Main_TooltipString += &quot;`r  Command: $($Program.Command)&quot;}
        if (![DBNull]::Value.Equals($Program.Arguments) -and $Program.Arguments){$tt_Main_TooltipString += &quot;`r  Arguments: $($Program.Arguments)&quot;}
        
		#Create the button at our calculated coordinates.
        $TempButton = New-Object System.Windows.Forms.Button
		$TempButton | % {
			$_.Anchor =([System.Windows.Forms.AnchorStyles]::Top -bor [System.Windows.Forms.AnchorStyles]::Left -bor [System.Windows.Forms.AnchorStyles]::Right)
			$_.Autosize = $True
			$_.AutosizeMode = [System.Windows.Forms.AutoSizeMode]::GrowAndShrink
			$_.BackColor = [System.Drawing.SystemColors]::Control
			$_.Location = New-Object System.Drawing.Point(6, $yCoordinate)
			$_.Name = (&quot;btn_&quot; + ($Program.Name -Replace &quot; &quot;,&quot;_&quot;)) #Replace all spaces with underlines. (This avoids errors.)
			$_.Size = New-Object System.Drawing.Size(241, 23)
			$_.TabIndex = 0
			$_.Text = $Program.Name
			$_.UseVisualStyleBackColor = $True
			
			#Event Handler to launch the program properly.
			$_.Add_Click({event_Click_ProgramButton $this $_})
			
			#Connect the tooltip to the button.
			$tt_Main_Tooltip.SetToolTip($_, $tt_Main_TooltipString)
			
			#Add the button to our form.
			$gb_Main_Programs.Controls.Add($_)			
		}
    }
    $gb_Main_Programs.PerformLayout()
    $form_MainLauncher.ResumeLayout($False)
    $form_MainLauncher.PerformLayout()
    if ($form_MainLauncher.WindowState -ne [System.Windows.Forms.FormWindowState]::Maximumized){
        AutoSize-Form $form_MainLauncher
    }
}
Function Add-Row{
    param([System.Data.DataSet]$DataSet, [string]$TableName, [hashtable]$RowData)
    $NewRow = $DataSet.Tables[$TableName].NewRow()
    $RowData.keys | % {$NewRow.$_ = $RowData.$_}
    $DataSet.Tables[$TableName].Rows.Add($NewRow)
}
Function Add-Table{
    param([System.Data.Dataset]$DataSet, [string]$TableName, [array]$Columns)
    $dtTable = New-Object System.Data.DataTable($TableName)
    $dtTable.Columns.AddRange(@($Columns))
    $DataSet.Tables.Add($dtTable)
}
Function Apply-Config{
    Add-ProgramButtons
}
Function Autosize-Form{
    param(
		[System.Windows.Forms.Form]$Form
	)
	
    $Form.AutosizeMode = [System.Windows.Forms.AutoSizeMode]::GrowAndShrink
    $Form.AutosizeMode = [System.Windows.Forms.AutoSizeMode]::GrowOnly
}
Function Create-Config{
    #Create a brand new dataset.
    $script:xmlConfig = New-Object System.Data.DataSet(&quot;AdminLauncher&quot;)
    #Determine program files location for 32bit/64bit apps.
    switch ([intptr]::Size -eq 8){
        $True{$ProgramFiles = (Get-Item &quot;${env:ProgramFiles(x86)}&quot;).FullName}
        $False{$ProgramFiles = (Get-Item &quot;${env:ProgramFiles}&quot;).FullName}
    }
    #Define table structures for the config tables.
    $htSettings = @{
        DataSet=$script:xmlConfig
        TableName=&quot;Settings&quot;
        Columns=@(&quot;Program&quot;, &quot;ProgramDate&quot;, &quot;Version&quot;, &quot;Author&quot;, &quot;AuthorEmail&quot;, &quot;UserName&quot;, &quot;UserDomain&quot;)
    }
    $htPrograms = @{
        DataSet=$script:xmlConfig
        TableName=&quot;Programs&quot;
        Columns=@(&quot;Name&quot;, &quot;Command&quot;, &quot;Arguments&quot;)
    }
    #Add base configuration tables to the dataset.
    Add-Table @htSettings
    Add-Table @htPrograms
    #Capture configuration data.
	if (&quot;$env:USERDNSDOMAIN&quot;){
		$UserDomain = &quot;$env:USERDNSDOMAIN&quot;
	}
	else{
		$UserDomain = &quot;$env:COMPUTERNAME&quot;
	}
	
    $htSettings = @{
        DataSet=$script:xmlConfig
        TableName=&quot;Settings&quot;
        RowData = @{
            Program=$script:ProgramName
			ProgramDate=$script:ProgramDate
            Version=$script:ScriptVersion
            Author=$script:ProgramAuthor
			AuthorEmail =$script:ProgramAuthorEmail
            UserName=&quot;$env:USERNAME&quot;
            UserDomain=$UserDomain
        }
    }
    #Add configuration data to the dataset.
    Add-Row @htSettings
    #Define each default program and add it to the dataset.
    Add-Program -DataSet $script:xmlConfig -Name &quot;Active Directory&quot; -Command &quot;$env:WINDIR\system32\mmc.exe&quot; -Arguments &quot;$env:WINDIR\system32\dsa.msc&quot;
    Add-Program -DataSet $script:xmlConfig -Name &quot;ADSI Editor&quot; -Command &quot;$env:WINDIR\system32\mmc.exe&quot; -Arguments &quot;$env:WINDIR\system32\adsiedit.msc&quot;
    Add-Program -DataSet $script:xmlConfig -Name &quot;Computer Management&quot; -Command &quot;$env:WINDIR\system32\mmc.exe&quot; -Arguments &quot;$env:WINDIR\system32\compmgmt.msc /s&quot;
    Add-Program -DataSet $script:xmlConfig -Name &quot;DHCP Configuration&quot; -Command &quot;$env:WINDIR\system32\mmc.exe&quot; -Arguments &quot;$env:WINDIR\system32\dhcpmgmt.msc&quot;
    Add-Program -DataSet $script:xmlConfig -Name &quot;DNS Configuration&quot; -Command &quot;$env:WINDIR\system32\mmc.exe&quot; -Arguments &quot;$env:WINDIR\system32\dnsmgmt.msc /s&quot;
    Add-Program -DataSet $script:xmlConfig -Name &quot;Group Policy Management&quot; -Command &quot;$env:WINDIR\system32\mmc.exe&quot; -Arguments &quot;$env:WINDIR\system32\gpmc.msc&quot;
    Add-Program -DataSet $script:xmlConfig -Name &quot;Powershell Console&quot; -Command &quot;$pshome\powershell.exe&quot; -Arguments &quot;-STA&quot;
    Add-Program -DataSet $script:xmlConfig -Name &quot;Powershell ISE&quot; -Command &quot;$pshome\powershell_ISE.exe&quot;
    Add-Program -DataSet $script:xmlConfig -Name &quot;Print Management&quot; -Command &quot;$env:WINDIR\system32\mmc.exe&quot; -Arguments &quot;$env:WINDIR\system32\printmanagement.msc&quot;
    Add-Program -DataSet $script:xmlConfig -Name &quot;Remote Desktop&quot; -Command &quot;$env:WINDIR\system32\mstsc.exe&quot;
}
Function Get-DomainInfo{
    #Get the current forest.
    try{ #This can fail if we're not on a domain. Let's make sure to catch exceptions gracefully.
        $Forest = [System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest()
        $MemberDomains = @()
        $ForestSites = @($Forest.Sites)
        
        if ($ForestSites){
            $ForestSites | % {
                if ($_.Domains){
                    $_.Domains | % {
                        if ($MemberDomains -notcontains $_.Name){
                            $MemberDomains += $_.Name.ToUpper()
                        }
                    }
                }
            }
        }
        else{ #Get other domains from forest trusts.
            $ForestTrusts = @($Forest.GetAllTrustRelationships())
            if ($ForestTrusts){
                $DomainNames = $ForestTrusts |
                    ? {$_.TrustType -eq [System.DirectoryServices.ActiveDirectory.TrustType]::Forest} |
                    % {$_.TrustedDomainInformation |
                    % {$_.dnsName}}
                if ($DomainNames){
                    $DomainNames | % {
                        $MemberDomains += $_.ToUpper()
                    }
                }
            }
        }
    }
    catch{ #We don't need to do anything if this fails. The array will be generated regardless.
    }
    finally{
		if ($MemberDomains){
			#Add the user's current domain to the array if not already present.
			if ($MemberDomains -notcontains $env:USERDNSDOMAIN){
				$MemberDomains += $env:USERDNSDOMAIN
			}
            
			#Add the domain information to the dropdown list.
			$cb_Main_Domain.Items.AddRange(($MemberDomains | Sort-Object -unique))
			
			if ($script:xmlConfig.Tables[&quot;Cache&quot;]){ #Use cached information if we have any.
				if (![DBNull]::Value.Equals($script:xmlConfig.Tables[&quot;Cache&quot;].Rows[0].Domain) -and $script:xmlConfig.Tables[&quot;Cache&quot;].Rows[0].Domain){
					$cb_Main_Domain.Text = $script:xmlConfig.Tables[&quot;Cache&quot;].Rows[0].Domain
				}
			}
            elseif ($env:USERDNSDOMAIN){ #Use domain info if available.
                $cb_Main_Domain.Text = $env:USERDNSDOMAIN
            }
            else{ #Use item 1 from the list.
                $cb_Main_Domain.Text = $cb_Main_Domain.Items[0]
            }
		}
        elseif ($env:USERDNSDOMAIN){ #Use domain info if available.
            $cb_Main_Domain.Items.Add($env:USERDNSDOMAIN)
            $cb_Main_Domain.Text = $env:USERDNSDOMAIN
        }
		else{ #There is no domain membership, use local computer name.
			$cb_Main_Domain.Items.Add($env:COMPUTERNAME)
			$cb_Main_Domain.Text = $env:COMPUTERNAME
		}
    }
}
Function Load-Config{
    if (Test-Path $script:xmlConfigFile){ #The config exists, read it.
        $script:xmlConfig.ReadXml($script:xmlConfigFile) | Out-Null
        $script:xmlConfig.AcceptChanges()
    }
    else{ #The config doesn't exist, create it.
        Create-Config
        if (!(Test-Path (Split-Path -Path $script:xmlConfigFile -Parent))){
            mkdir (Split-Path -Path $script:xmlConfigFile -Parent)
        }
        [void]$script:xmlConfig.WriteXml($script:xmlConfigFile)
        $script:xmlConfig.AcceptChanges()
    }
    #Validate the config file according to our schema.
    if (Validate-Config $script:xmlConfig){
        if ($script:xmlConfig.Tables[&quot;Cache&quot;]){
            if (![DBNull]::Value.Equals($script:xmlConfig.Tables[&quot;Cache&quot;].Rows[0].Name) -and $script:xmlConfig.Tables[&quot;Cache&quot;].Rows[0].Name){
                $tb_Main_UserName.Text = $script:xmlConfig.Tables[&quot;Cache&quot;].Rows[0].Name
            }
            if (![DBNull]::Value.Equals($script:xmlConfig.Tables[&quot;Cache&quot;].Rows[0].Domain) -and $script:xmlConfig.Tables[&quot;Cache&quot;].Rows[0].Domain){
                $cb_Main_Domain.Text = $script:xmlConfig.Tables[&quot;Cache&quot;].Rows[0].Domain
            }
        }
        Apply-Config
    }
    #Something is wrong with the config file, offer to recreate it or exit if it is not re-created.
    else{
        $htPrompt = @{
            Caption=&quot;Invalid Configuration File!&quot;
            Message=&quot;An incompatible configuration file exists!`nWould you like to re-build one from the default settings?&quot;
            DialogOptions=&quot;YesNo&quot;
        }
        $DialogResult = [System.Windows.Forms.MessageBox]::Show($htPrompt.Message, $htPrompt.Caption, $htPrompt.DialogOptions)
        if ($DialogResult -eq [System.Windows.Forms.DialogResult]::Yes){
            rm -force $script:xmlConfigFile -EA &quot;SilentlyContinue&quot;
            Load-Config
        }
        else{$form_MainLauncher.Close()}
    }
}
Function Validate-Config{
    param([System.Data.DataSet]$DataSet)
    try{
		#Read settings table from the XML dataset.
		$SettingsInfo = $DataSet.Tables[&quot;Settings&quot;].Rows[0]
		
        if ($SettingsInfo.Program -eq $script:ProgramName){ #ProgramName matches
			if ($SettingsInfo.Author -eq $script:ProgramAuthor){ #ProgramAuthor matches
				return $True
			}
			else{
				return $False
			}
		}
		else{
			return $False
		}
	}
    catch{ #Any exceptions will read as a failed validation.
		return $False
	}
}
&lt;# End ---- Admin Launcher Helper Functions ---- #&gt;

&lt;# Begin ---- Admin Launcher Event Handler Functions ---- #&gt;
Function event_Load_form_MainLauncher{
    param(
        $object,
        $e
    )
    #Populate data fields.
    $tssl_Main_StatusStripLabel.Text = &quot;Launcher Ready&quot;
    #Load the configuration
    Load-Config
    Get-DomainInfo
}
Function event_Click_tsmi_Main_Import{
    param(
        $object,
        $e
    )
	
    $DialogResult = $dlg_OpenFile.ShowDialog()
    try{
        if ($DialogResult -eq [System.Windows.Forms.DialogResult]::OK){
            $ImportData = New-Object System.Data.DataSet
            [void]$ImportData.ReadXml($dlg_OpenFile.FileName)
            if (Validate-Config $ImportData){
                $htPrompt = @{
                    Caption=&quot;Import Settings&quot;
                    Message=&quot;You have chosen to import settings, this will erase all existing settings.`r`n`r`nAre you sure you want to do this?&quot;
                    DialogOptions=&quot;YesNo&quot;
                }
                $DialogResult = [System.Windows.Forms.MessageBox]::Show($htPrompt.Message, $htPrompt.Caption, $htPrompt.DialogOptions)
                if ($DialogResult -eq [System.Windows.Forms.DialogResult]::Yes){
                    $ImportData.Tables.Remove(&quot;Settings&quot;)
                    $ImportData.AcceptChanges()
                    $htSettings = @{
                        DataSet=$ImportData
                        TableName=&quot;Settings&quot;
                        Columns=@(&quot;Program&quot;, &quot;Version&quot;, &quot;Author&quot;, &quot;UserName&quot;, &quot;UserDomain&quot;)
                    }
                    Add-Table @htSettings
                    $htSettings = @{
                        DataSet=$ImportData
                        TableName=&quot;Settings&quot;
                        RowData = @{
                            Program=$script:ProgramName
                            Version=$script:ScriptVersion
                            Author=$script:ProgramAuthor
                            UserName=&quot;$env:USERNAME&quot;
                            UserDomain=&quot;$env:USERDNSDOMAIN&quot;
                        }
                    }
                    Add-Row @htSettings
                    $script:xmlConfig = $ImportData.Copy()
                    Apply-Config
                    $tssl_Main_StatusStripLabel.Text = &quot;Import successful!&quot;
                }
            }
            else {Throw &quot;Invalid configuration file!&quot;}
        }
    }
    catch{
        $htError = @{
            Caption=&quot;Import Settings&quot;
            Message=(&quot;Your settings could not be imported! The following error was reported.`r`n`r`n&quot; + $error[0].exception.message)
            DialogOptions=&quot;OkCancel&quot;
        }
        [System.Windows.Forms.MessageBox]::Show($htError.Message, $htError.Caption, $htError.DialogOptions)
    }
}
Function event_Click_tsmi_Main_Export{
    param(
        $object,
        $e
    )
	
    if ($dlg_SaveFile.ShowDialog() -eq [System.Windows.Forms.DialogResult]::OK){
        try{
            $xmlSave = $script:xmlConfig.Copy()
            if ($xmlSave.Tables[&quot;Settings&quot;].Rows[0].Username -ne $Null) {$xmlSave.Tables[&quot;Settings&quot;].Rows[0].Username = $Null}
            if ($xmlSave.Tables[&quot;Settings&quot;].Rows[0].UserDomain -ne $Null) {$xmlSave.Tables[&quot;Settings&quot;].Rows[0].UserDomain = $Null}
            if ($xmlSave.Tables[&quot;Cache&quot;] -ne $Null){
                try{
                    $xmlSave.Tables[&quot;Cache&quot;].Rows[0].Name = $Null
                    $xmlSave.Tables[&quot;Cache&quot;].Rows[0].Domain = $Null
                }
                catch{}
            }
            [void]$xmlSave.WriteXml($dlg_SaveFile.FileName)
        }
        catch{}
    }
}
Function event_Click_tsmi_Main_Reset{
    param(
        $object,
        $e
    )
	
    $htPrompt = @{
        Caption=&quot;Reset all settings&quot;
        Message=&quot;You have chosen to reset all settings to default. This will remove ALL changes you have made. Are you sure you want to do this?&quot;
        DialogOptions=&quot;YesNo&quot;
    }
    $DialogResult = [System.Windows.Forms.MessageBox]::Show($htPrompt.Message, $htPrompt.Caption, $htPrompt.DialogOptions)
    if ($DialogResult -eq [System.Windows.Forms.DialogResult]::Yes){
        if (Test-Path $script:xmlConfigFile){
            Remove-Item  -Path $script:xmlConfigFile -Force
        }
		Load-Config
		Autosize-Form $form_MainLauncher
    }
}
Function event_Activated_form_Config{
    param(
        $object,
        $e
    )
	
    #Sort the table by program name. (So each time config opens, they're alphabetical)
    $script:xmlConfig.Tables[&quot;Programs&quot;].DefaultView.Sort = &quot;Name&quot;
    
    #Bind the gridview to the config file's programs table.
    $dgv_Config_Programs.DataSource = $script:XmlConfig.Tables[&quot;Programs&quot;]   
}
Function event_Deactivate_form_Config{
    param(
        $object,
        $e
    )

    if ($object.DialogResult -eq [System.Windows.Forms.DialogResult]::OK){ #If the user pressed the done button, commit the changes to our main config.
        
        #Make sure to remove any programs that do not have a name.
        foreach ($Row in $script:xmlConfig.Tables[&quot;Programs&quot;].Rows){
            if ([DBNull]::Value.Equals($Row.Name) -or !$Row.Name){
                $Row.Delete()
            }
        }
        if ($script:xmlConfig.HasChanges()){
            $script:xmlConfig.Tables[&quot;Programs&quot;].AcceptChanges()
            [void]$script:xmlConfig.WriteXml($script:xmlConfigFile)
            Add-ProgramButtons $script:xmlConfig
        }
    }
    else{
        if ($script:xmlConfig.HasChanges()){
            $script:xmlConfig.Tables[&quot;Programs&quot;].RejectChanges()
        }
    }
}
Function event_Click_ProgramButton{
    param(
		$object,
		$e
	)
    
    #Reference the xml program that this button represents.
    $CurrentProgram = $script:xmlconfig.Tables[&quot;Programs&quot;] | ? {$object.Text -eq $_.Name}
    
    $tssl_Main_StatusStripLabel.Text = &quot;$($CurrentProgram.Name) starting...&quot;

    #Build the command string based on what parameters we have.
    if (![DBNull]::Value.Equals($CurrentProgram.Command) `
        -and $CurrentProgram.Command
    ){
        $sb_StartElevatedProcess = {
            param(
                $CurrentProgram
            )

            $ProcInfo = New-Object System.Diagnostics.ProcessStartInfo($CurrentProgram.Command)

            if ($CurrentProgram.Arguments){
                $ProcInfo.Arguments = $CurrentProgram.Arguments
            }

            $ProcInfo.UseShellExecute = $True
            $ProcInfo.Verb = &quot;RunAs&quot;
            try{
                $Proc = [Diagnostics.Process]::Start($ProcInfo)
            }
            catch{
                throw $_
            }
        }
        try{
            $job_params = @{
                ScriptBlock = $sb_StartElevatedProcess
                ArgumentList = $CurrentProgram
            }
            
            if ($cb_Main_Domain.Text -and $tb_Main_UserName.Text -and $mtb_Main_Password.Text){
                $Credential = New-Object System.Management.Automation.PSCredential(&quot;$($cb_Main_Domain.Text)\$($tb_Main_UserName.Text)&quot;,$SecurePassword)
                $job_params.Credential = $Credential
            }            

            $Job = Start-Job @job_params
            Wait-Job $Job
            if ($Job.State -ne &quot;Completed&quot;){throw}
            $tssl_Main_StatusStripLabel.Text = &quot;$($CurrentProgram.Name) launched.&quot;
        }
        catch{
            $tssl_Main_StatusStripLabel.Text = &quot;$($CurrentProgram.Name) failed!&quot;
            $htError = @{
                Caption=&quot;Program Button&quot;
                Message=(&quot;The program failed to launch!`r`n`r`n&quot; + $error[0].exception.message)
                DialogOptions=&quot;OkCancel&quot;
            }
            [System.Windows.Forms.MessageBox]::Show($htError.Message, $htError.Caption, $htError.DialogOptions)
        }
    }
    #The program did not have a command defined, change the status bar to reflect this and exit the event handler.
    else{$tssl_Main_StatusStripLabel.Text = &quot;Program: $($CurrentProgram.Name) has no command!&quot;}
}
Function event_KeyUp_tb_Main_UserName{
    param(
		$object, 
		$e
	)

    #Update the config in memory with the new username
    if ($tb_Main_UserName.Text -and $cb_Main_Domain.Text){
        $script:xmlConfigHasChanged = $True
        if ($script:xmlConfig.Tables[&quot;Cache&quot;]-eq $Null){
            $htCache = @{
                DataSet=$script:xmlconfig
                TableName=&quot;Cache&quot;
                Columns=@(&quot;Name&quot;, &quot;Domain&quot;)
            }
            $htRow = @{
                DataSet=$script:xmlconfig
                TableName=&quot;Cache&quot;
                RowData=@{
                    Name=$tb_Main_UserName.Text
                    Domain=$cb_Main_Domain.Text
                }
            }
            Add-Table @htCache
            Add-Row @htRow
        }
        else{
            $script:xmlConfig.Tables[&quot;Cache&quot;].Rows[0].Name = $tb_Main_UserName.Text
            $script:xmlConfig.Tables[&quot;Cache&quot;].Rows[0].Domain = $cb_Main_Domain.Text
        }
    }
}
Function event_KeyDown_tb_Main_UserName{
    param(
		$object, 
		[System.Windows.Forms.KeyEventArgs]$e
	)

    $enumKeys = [System.Windows.Forms.Keys]

    $e.Handled = $True
    $e.SuppressKeyPress = $True
    $SelectionStart = $object.SelectionStart
    switch ($e.KeyCode){
        $EnumKeys::Enter {
            $form_MainLauncher.SelectNextControl($object, $true, $true, $true, $true)
        }
        default{
            $e.Handled = $False
            $e.SuppressKeyPress = $False
        }
    }
}
Function event_KeyDown_mtb_Main_Password{ #Catch special keys on the password box.
    param(
		$object, 
		[System.Windows.Forms.KeyEventArgs]$e
	)

    $enumKeys = [System.Windows.Forms.Keys]

    $e.Handled = $True
    $e.SuppressKeyPress = $True
    $SelectionStart = $object.SelectionStart

    switch ($e.KeyCode){
        $enumKeys::Enter {
            #Make the enter key act like a tab key.
            $form_MainLauncher.SelectNextControl($object, $true, $true, $true, $true)
        }
        $enumKeys::Back {
            #They want to delete a selection of text.
            #Loop through each letter in their selection and perform a delete for each one.
            if ($object.SelectionLength -gt 0){
                foreach($Letter in [char[]]$object.SelectedText){
                    $SecurePassword.RemoveAt($SelectionStart)
                    $object.Text = $object.Text.Remove($SelectionStart, 1)
                }
            }
            #They have no selection and are not at the beginning of the string.
            #Determine where they are and delete the preceding character.
            elseif ($object.SelectionStart -gt 0){
                $SecurePassword.RemoveAt(($object.SelectionStart - 1))
                $object.Text = $object.Text.Remove($object.SelectionStart - 1, 1)
            }
            #They are at the beginning of the string with no selection
            #Do nothing.
            else{
                return
            }
        }
        $enumKeys::Delete {
            #They are at the end of the string.
            #Do nothing
            if ($object.SelectionStart -ge $SecurePassword.Length){
                return
            }
            #They want to delete a selection of text.
            #Loop through each letter in their selection and perform a delete for each one.
            elseif ($object.SelectionLength -gt 0){
                foreach($Letter in [char[]]$object.SelectedText){
                    $SecurePassword.RemoveAt($SelectionStart)
                    $object.Text = $object.Text.Remove($SelectionStart, 1)
                }
            }
            #They have no selection and are somewhere before the end of the string.
            #Delete the letter at their location.
            else{
                $SecurePassword.RemoveAt($object.SelectionStart)
                $object.Text = $object.Text.Remove($object.SelectionStart, 1)
            }
        }
        #Control+V clipboard paste
        {$e.Modifiers -eq $enumKeys::Control -and $e.KeyCode -eq $EnumKeys::V}{
            if ([System.Windows.ClipBoard]::GetText()){ #Only paste if there is data on the clipboard.
                if ($object.SelectionStart -ge $SecurePassword.Length){ #Only paste onto the end or onto a blank password box.
                    foreach ($Letter in [char[]][System.Windows.Clipboard]::GetText()){
                        $SecurePassword.AppendChar($Letter)
                        [string]$object.Text += &quot;*&quot;
                    }
                    $SelectionStart = $SecurePassword.Length
                }
            }
        }
        #They pressed some other key.
        #Tell the system to handle it with the keypress event.
        default{
            $e.Handled = $False
            $e.SuppressKeyPress = $False
        }
    }
    #Reset the selection data.
    $object.SelectionStart = $SelectionStart
}
Function event_KeyPress_mtb_Main_Password{ #Catch all other keypresses on the password box.
    param(
		$object, 
		[System.Windows.Forms.KeyPressEventArgs]$e
	)
	
    $e.Handled = $True
    $SelectionStart = $object.SelectionStart
    #They are at the end of the string.
    #Append each character they enter.
    if ($object.SelectionStart -ge $SecurePassword.Length){
        $SecurePassword.AppendChar($e.KeyChar.ToString())
        [string]$object.Text += &quot;*&quot;
        $SelectionStart++
    }
    #They have a selection of characters.
    #Delete the selection and insert from their location.
    elseif($object.SelectionLength -gt 0){
        #Delete the selection
        foreach($Letter in [char[]]$object.SelectedText){
            $SecurePassword.RemoveAt($SelectionStart)
            $object.Text = $object.Text.Remove($SelectionStart, 1)
        }
        #Insert the single character
        $SecurePassword.InsertAt($SelectionStart, $e.KeyChar.ToString())
        $object.Text = [string]$object.Text.Insert($SelectionStart, &quot;*&quot;)
        $SelectionStart++
    }
    #They are somewhere in the string.
    #Insert at their location.
    else{
        #Insert the single character
        $SecurePassword.InsertAt($SelectionStart, $e.KeyChar.ToString())
        $object.Text = [string]$object.Text.Insert($SelectionStart, &quot;*&quot;)
        $SelectionStart++
    }
    #Reset the selection data.
    $object.SelectionStart = $SelectionStart
    $object.SelectionLength = 0
}
Function event_FormClosing_form_MainLauncher{
    param(
		$object, 
		$e
	)
	
    if ($script:xmlConfig.HasChanges() -eq $True){
        [void]$script:xmlConfig.WriteXml($script:xmlConfigFile)
    }
}
Function event_Click_tsmi_Main_Configure{
    param(
        $object,
        $e
    )
	
	$form_Config.ShowDialog()
}
Function event_Click_btn_Config_Done{
    param(
        $object,
        $e
    )
	
	$form_Config.DialogResult = [System.Windows.Forms.DialogResult]::OK
}
Function event_Click_tsmi_Main_Exit{
    param(
        $object,
        $e
    )
	
	$form_MainLauncher.Close()
}
&lt;# End ---- Admin Launcher Event Handler Functions ---- #&gt;

&lt;# Begin ---- Admin Launcher Event Handler Definitions ---- #&gt;
#Main Form
$form_MainLauncher.Add_Load({event_Load_form_MainLauncher $this $_})
$form_MainLauncher.Add_FormClosing({event_FormClosing_form_MainLauncher $this $_})
$cb_Main_Domain.Add_SelectionChangeCommitted({event_KeyUp_Tb_Main_UserName $this $_})
$mtb_Main_Password.Add_KeyDown({event_KeyDown_mtb_Main_Password $this $_})
$mtb_Main_Password.Add_KeyPress({event_KeyPress_mtb_Main_Password $this $_})
$tb_Main_UserName.Add_KeyUp({event_KeyUp_tb_Main_UserName $this $_})
$tb_Main_UserName.Add_KeyDown({event_KeyDown_tb_Main_UserName $this $_})
$tsmi_Main_Configure.Add_Click({event_Click_tsmi_Main_Configure $this $_})
$tsmi_Main_Import.Add_Click({event_Click_tsmi_Main_Import $this $_})
$tsmi_Main_Export.Add_Click({event_Click_tsmi_Main_Export $this $_})
$tsmi_Main_Reset.Add_Click({event_Click_tsmi_Main_Reset $this $_})
$tsmi_Main_Exit.Add_Click({event_Click_tsmi_Main_Exit $this $_})

#Config Form
$form_Config.Add_Activated({event_Activated_form_Config $this $_})
$form_Config.Add_Deactivate({event_Deactivate_form_Config $this $_})
$btn_Config_Done.Add_Click({event_Click_btn_Config_Done $this $_})
&lt;# End ---- Admin Launcher Event Handler Definitions ---- #&gt;

&lt;# Begin ---- Admin Launcher layout calls ---- #&gt;
$tlp_Config.ResumeLayout($False)
$gb_Main_Programs.ResumeLayout($False)
$form_Config.ResumeLayout($False)
$ss_Main_StatusStrip.ResumeLayout($False)
$ss_Main_StatusStrip.PerformLayout()
$ms_Main_MenuStrip.ResumeLayout($False)
$ms_Main_MenuStrip.PerformLayout()
$tlp_Main.ResumeLayout($False)
$tlp_Main.PerformLayout()
$gb_Main_Programs.ResumeLayout($False)
$gb_Main_RunAs.ResumeLayout($False)
$gb_Main_RunAs.PerformLayout()
$gb_Config_Programs.ResumeLayout($False)
$gb_Config_Programs.PerformLayout()
$form_MainLauncher.ResumeLayout($False)
$form_MainLauncher.PerformLayout()
&lt;# End ---- Admin Launcher layout calls ---- #&gt;

&lt;# This is the last line of the script, nothing after it will execute until the form is closed. #&gt;
$form_MainLauncher.ShowDialog() | Out-Null

&lt;# Dispose the secure password after we're done using launcher. #&gt;
$SecurePassword.Dispose()
</code></pre>

</div>

    <footer class="blog-footer">
        <p>&copy; Joel &quot;Jaykul&quot; Bennett 2018</p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="/js/main.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-59988721-1', 'auto');
      ga('send', 'pageview');

      $(function () {
          $('#contentTabs a:first').tab('show')
      })

    </script>
</body>
</html>